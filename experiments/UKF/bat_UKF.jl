using LinearAlgebra, Random, Distributions, Plots, Infiltrator
using DifferentialEquations
using ReverseDiff, Turing ,StatsPlots, Noise
using Dates
# https://github.com/EEA-sensors/Bayesian-Filtering-and-Smoothing/blob/main/matlab/examples/pendulum_ukf.m
using CSV, DataFrames
using Measures
using LaTeXStrings, Turing

# Simulation parameters
DT = 0.01
g = 9.81
Q = 0.01 * [DT^3/3 DT^2/2; DT^2/2 DT]
R = 0.1
m0 = [0.0; 0.0]
P0 = [1.0 0.0; 0.0 1.0]

steps = 500

# Generate simulated data
QL = cholesky(Q).L
T = zeros(steps)
X = zeros(2, steps)
Y = zeros(steps)
t = 0.0
x = [1.5; 0.0]
# for k in 1:steps
#     x = [x[1] + x[2] * DT; x[2] - g * sin(x[1]) * DT]
#     w = QL* randn(2)
#     x += w
#     y = sin(x[1]) + sqrt(R) * randn()   #Example 5.2 (Measurement model for noisy pendulum) in Simo's Book.
#     t += DT
#     T[k] = t
#     X[:, k] = x
#     Y[k] = y
# end


# p1=plot(T, sin.(X[1, :]), linecolor=:blue, label="Process model estimations")
# plot!(T, Y, seriestype=:scatter, label="Measurements", color=:green)
# xlabel!("t")
# ylabel!("Angular position")
# p2=plot( X[1, :], X[2, :], linecolor=:blue, label="True", size=(500,500))
# xlabel!("Angular velocity")
# ylabel!("Angular position")
# ppp=plot(p1, p2, layout=(2, 1), size=(1000, 1000))
# display(ppp)



T=[0.01, 0.02, 0.03, 0.04, 0.05, 0.060000000000000005, 0.07, 0.08, 0.09, 0.09999999999999999, 0.10999999999999999, 0.11999999999999998, 0.12999999999999998, 0.13999999999999999, 0.15, 0.16, 0.17, 0.18000000000000002, 0.19000000000000003, 0.20000000000000004, 0.21000000000000005, 0.22000000000000006, 0.23000000000000007, 0.24000000000000007, 0.25000000000000006, 0.26000000000000006, 0.2700000000000001, 0.2800000000000001, 0.2900000000000001, 0.3000000000000001, 0.3100000000000001, 0.3200000000000001, 0.3300000000000001, 0.34000000000000014, 0.35000000000000014, 0.36000000000000015, 0.37000000000000016, 0.38000000000000017, 0.3900000000000002, 0.4000000000000002, 0.4100000000000002, 0.4200000000000002, 0.4300000000000002, 0.4400000000000002, 0.45000000000000023, 0.46000000000000024, 0.47000000000000025, 0.48000000000000026, 0.49000000000000027, 0.5000000000000002, 0.5100000000000002, 0.5200000000000002, 0.5300000000000002, 0.5400000000000003, 0.5500000000000003, 0.5600000000000003, 0.5700000000000003, 0.5800000000000003, 0.5900000000000003, 0.6000000000000003, 0.6100000000000003, 0.6200000000000003, 0.6300000000000003, 0.6400000000000003, 0.6500000000000004, 0.6600000000000004, 0.6700000000000004, 0.6800000000000004, 0.6900000000000004, 0.7000000000000004, 0.7100000000000004, 0.7200000000000004, 0.7300000000000004, 0.7400000000000004, 0.7500000000000004, 0.7600000000000005, 0.7700000000000005, 0.7800000000000005, 0.7900000000000005, 0.8000000000000005, 0.8100000000000005, 0.8200000000000005, 0.8300000000000005, 0.8400000000000005, 0.8500000000000005, 0.8600000000000005, 0.8700000000000006, 0.8800000000000006, 0.8900000000000006, 0.9000000000000006, 0.9100000000000006, 0.9200000000000006, 0.9300000000000006, 0.9400000000000006, 0.9500000000000006, 0.9600000000000006, 0.9700000000000006, 0.9800000000000006, 0.9900000000000007, 1.0000000000000007, 1.0100000000000007, 1.0200000000000007, 1.0300000000000007, 1.0400000000000007, 1.0500000000000007, 1.0600000000000007, 1.0700000000000007, 1.0800000000000007, 1.0900000000000007, 1.1000000000000008, 1.1100000000000008, 1.1200000000000008, 1.1300000000000008, 1.1400000000000008, 1.1500000000000008, 1.1600000000000008, 1.1700000000000008, 1.1800000000000008, 1.1900000000000008, 1.2000000000000008, 1.2100000000000009, 1.2200000000000009, 1.2300000000000009, 1.2400000000000009, 1.2500000000000009, 1.260000000000001, 1.270000000000001, 1.280000000000001, 1.290000000000001, 1.300000000000001, 1.310000000000001, 1.320000000000001, 1.330000000000001, 1.340000000000001, 1.350000000000001, 1.360000000000001, 1.370000000000001, 1.380000000000001, 1.390000000000001, 1.400000000000001, 1.410000000000001, 1.420000000000001, 1.430000000000001, 1.440000000000001, 1.450000000000001, 1.460000000000001, 1.470000000000001, 1.480000000000001, 1.490000000000001, 1.500000000000001, 1.5100000000000011, 1.5200000000000011, 1.5300000000000011, 1.5400000000000011, 1.5500000000000012, 1.5600000000000012, 1.5700000000000012, 1.5800000000000012, 1.5900000000000012, 1.6000000000000012, 1.6100000000000012, 1.6200000000000012, 1.6300000000000012, 1.6400000000000012, 1.6500000000000012, 1.6600000000000013, 1.6700000000000013, 1.6800000000000013, 1.6900000000000013, 1.7000000000000013, 1.7100000000000013, 1.7200000000000013, 1.7300000000000013, 1.7400000000000013, 1.7500000000000013, 1.7600000000000013, 1.7700000000000014, 1.7800000000000014, 1.7900000000000014, 1.8000000000000014, 1.8100000000000014, 1.8200000000000014, 1.8300000000000014, 1.8400000000000014, 1.8500000000000014, 1.8600000000000014, 1.8700000000000014, 1.8800000000000014, 1.8900000000000015, 1.9000000000000015, 1.9100000000000015, 1.9200000000000015, 1.9300000000000015, 1.9400000000000015, 1.9500000000000015, 1.9600000000000015, 1.9700000000000015, 1.9800000000000015, 1.9900000000000015, 2.0000000000000013, 2.010000000000001, 2.020000000000001, 2.0300000000000007, 2.0400000000000005, 2.0500000000000003, 2.06, 2.07, 2.0799999999999996, 2.0899999999999994, 2.099999999999999, 2.109999999999999, 2.1199999999999988, 2.1299999999999986, 2.1399999999999983, 2.149999999999998, 2.159999999999998, 2.1699999999999977, 2.1799999999999975, 2.1899999999999973, 2.199999999999997, 2.209999999999997, 2.2199999999999966, 2.2299999999999964, 2.239999999999996, 2.249999999999996, 2.259999999999996, 2.2699999999999956, 2.2799999999999954, 2.289999999999995, 2.299999999999995, 2.3099999999999947, 2.3199999999999945, 2.3299999999999943, 2.339999999999994, 2.349999999999994, 2.3599999999999937, 2.3699999999999934, 2.3799999999999932, 2.389999999999993, 2.399999999999993, 2.4099999999999926, 2.4199999999999924, 2.429999999999992, 2.439999999999992, 2.4499999999999917, 2.4599999999999915, 2.4699999999999913, 2.479999999999991, 2.489999999999991, 2.4999999999999907, 2.5099999999999905, 2.5199999999999902, 2.52999999999999, 2.53999999999999, 2.5499999999999896, 2.5599999999999894, 2.569999999999989, 2.579999999999989, 2.5899999999999888, 2.5999999999999885, 2.6099999999999883, 2.619999999999988, 2.629999999999988, 2.6399999999999877, 2.6499999999999875, 2.6599999999999873, 2.669999999999987, 2.679999999999987, 2.6899999999999866, 2.6999999999999864, 2.709999999999986, 2.719999999999986, 2.7299999999999858, 2.7399999999999856, 2.7499999999999853, 2.759999999999985, 2.769999999999985, 2.7799999999999847, 2.7899999999999845, 2.7999999999999843, 2.809999999999984, 2.819999999999984, 2.8299999999999836, 2.8399999999999834, 2.849999999999983, 2.859999999999983, 2.869999999999983, 2.8799999999999826, 2.8899999999999824, 2.899999999999982, 2.909999999999982, 2.9199999999999817, 2.9299999999999815, 2.9399999999999813, 2.949999999999981, 2.959999999999981, 2.9699999999999807, 2.9799999999999804, 2.9899999999999802, 2.99999999999998, 3.00999999999998, 3.0199999999999796, 3.0299999999999794, 3.039999999999979, 3.049999999999979, 3.0599999999999787, 3.0699999999999785, 3.0799999999999783, 3.089999999999978, 3.099999999999978, 3.1099999999999777, 3.1199999999999775, 3.1299999999999772, 3.139999999999977, 3.149999999999977, 3.1599999999999766, 3.1699999999999764, 3.179999999999976, 3.189999999999976, 3.1999999999999758, 3.2099999999999755, 3.2199999999999753, 3.229999999999975, 3.239999999999975, 3.2499999999999747, 3.2599999999999745, 3.2699999999999743, 3.279999999999974, 3.289999999999974, 3.2999999999999736, 3.3099999999999734, 3.319999999999973, 3.329999999999973, 3.3399999999999728, 3.3499999999999726, 3.3599999999999723, 3.369999999999972, 3.379999999999972, 3.3899999999999717, 3.3999999999999715, 3.4099999999999713, 3.419999999999971, 3.429999999999971, 3.4399999999999706, 3.4499999999999704, 3.45999999999997, 3.46999999999997, 3.47999999999997, 3.4899999999999696, 3.4999999999999694, 3.509999999999969, 3.519999999999969, 3.5299999999999687, 3.5399999999999685, 3.5499999999999683, 3.559999999999968, 3.569999999999968, 3.5799999999999677, 3.5899999999999674, 3.5999999999999672, 3.609999999999967, 3.619999999999967, 3.6299999999999666, 3.6399999999999664, 3.649999999999966, 3.659999999999966, 3.6699999999999657, 3.6799999999999655, 3.6899999999999653, 3.699999999999965, 3.709999999999965, 3.7199999999999647, 3.7299999999999645, 3.7399999999999642, 3.749999999999964, 3.759999999999964, 3.7699999999999636, 3.7799999999999634, 3.789999999999963, 3.799999999999963, 3.8099999999999627, 3.8199999999999625, 3.8299999999999623, 3.839999999999962, 3.849999999999962, 3.8599999999999617, 3.8699999999999615, 3.8799999999999613, 3.889999999999961, 3.899999999999961, 3.9099999999999606, 3.9199999999999604, 3.92999999999996, 3.93999999999996, 3.9499999999999598, 3.9599999999999596, 3.9699999999999593, 3.979999999999959, 3.989999999999959, 3.9999999999999587, 4.009999999999959, 4.019999999999959, 4.0299999999999585, 4.039999999999958, 4.049999999999958, 4.059999999999958, 4.069999999999958, 4.079999999999957, 4.089999999999957, 4.099999999999957, 4.109999999999957, 4.119999999999957, 4.129999999999956, 4.139999999999956, 4.149999999999956, 4.159999999999956, 4.1699999999999555, 4.179999999999955, 4.189999999999955, 4.199999999999955, 4.209999999999955, 4.2199999999999545, 4.229999999999954, 4.239999999999954, 4.249999999999954, 4.259999999999954, 4.269999999999953, 4.279999999999953, 4.289999999999953, 4.299999999999953, 4.3099999999999525, 4.319999999999952, 4.329999999999952, 4.339999999999952, 4.349999999999952, 4.3599999999999515, 4.369999999999951, 4.379999999999951, 4.389999999999951, 4.399999999999951, 4.40999999999995, 4.41999999999995, 4.42999999999995, 4.43999999999995, 4.4499999999999496, 4.459999999999949, 4.469999999999949, 4.479999999999949, 4.489999999999949, 4.4999999999999485, 4.509999999999948, 4.519999999999948, 4.529999999999948, 4.539999999999948, 4.549999999999947, 4.559999999999947, 4.569999999999947, 4.579999999999947, 4.589999999999947, 4.599999999999946, 4.609999999999946, 4.619999999999946, 4.629999999999946, 4.6399999999999455, 4.649999999999945, 4.659999999999945, 4.669999999999945, 4.679999999999945, 4.689999999999944, 4.699999999999944, 4.709999999999944, 4.719999999999944, 4.729999999999944, 4.739999999999943, 4.749999999999943, 4.759999999999943, 4.769999999999943, 4.7799999999999425, 4.789999999999942, 4.799999999999942, 4.809999999999942, 4.819999999999942, 4.8299999999999415, 4.839999999999941, 4.849999999999941, 4.859999999999941, 4.869999999999941, 4.87999999999994, 4.88999999999994, 4.89999999999994, 4.90999999999994, 4.9199999999999395, 4.929999999999939, 4.939999999999939, 4.949999999999939, 4.959999999999939, 4.9699999999999385, 4.979999999999938, 4.989999999999938, 4.999999999999938]

X1=[1.5000316645743017, 1.4990812683551376, 1.4972815604956697, 1.4944695375041837, 1.4906662514360427, 1.4860282236230806, 1.4804110551784446, 1.473999444799985, 1.466778490858508, 1.4586035418845547, 1.44944008581249, 1.4393264547503901, 1.4282797834444119, 1.4163621510652553, 1.403602243742768, 1.3898984312065807, 1.3751709655667543, 1.3594466846592714, 1.3427823798559622, 1.3252252891256697, 1.3065887976162944, 1.287037330117684, 1.2664153255936614, 1.2447812203252493, 1.2222608169551903, 1.1989454824955692, 1.1747904558804667, 1.1496906626089094, 1.1235853951332688, 1.096679758579015, 1.0689307908560457, 1.0405123471792197, 1.0113377374557362, 0.981335039573715, 0.9505833148215287, 0.9189462551771876, 0.8865052297141226, 0.8534110047452128, 0.8196346299326855, 0.7852145155529981, 0.7502022654406357, 0.7144110128531042, 0.677814919535779, 0.6404555555353981, 0.6023809850331788, 0.5638194299903461, 0.5247401727205087, 0.4850169190545121, 0.44472723033128897, 0.40390408855530546, 0.3626712795339464, 0.32100890065671484, 0.27910335913391254, 0.23705358859044612, 0.194779254394979, 0.15240531753685857, 0.10990360973065604, 0.06719543327992375, 0.024407550891254272, -0.018461170950758554, -0.06143425459281735, -0.10450051935439322, -0.14762776639875055, -0.19059107205008086, -0.23318839281071954, -0.2756412183171865, -0.3177954232068403, -0.3595287842907413, -0.40104142443566154, -0.44240425353856955, -0.48340233264343824, -0.5239374603255805, -0.5639717372448726, -0.6034893462319911, -0.6424121237687975, -0.6807415999256854, -0.718416883511316, -0.7554306987450451, -0.7917848344104794, -0.8274109187555978, -0.8623396045393849, -0.8965988487370138, -0.9299759315230886, -0.9625966359739274, -0.9944974086291757, -1.0257373466304491, -1.0563216314761052, -1.0859906215793584, -1.1148322830267934, -1.1428894542113408, -1.1701927249914832, -1.1966703684397801, -1.2222800950697386, -1.2470720039632288, -1.2710617574265144, -1.2941135895681395, -1.3160374256252243, -1.337134834845583, -1.357311053420632, -1.3766251547085895, -1.3951192170522286, -1.4126872944150144, -1.4293467462269303, -1.4451021786044584, -1.4598405780772559, -1.4735756132764148, -1.4862069671868936, -1.49781274246545, -1.5084354331676628, -1.5180760704677791, -1.5267418145200395, -1.5343639425274234, -1.5410735158770024, -1.5469096586308817, -1.5517534563731592, -1.5556294138492404, -1.558569768311659, -1.5606436299578819, -1.56185504436258, -1.5621266344211793, -1.5613726490275903, -1.559678603109344, -1.5569764175201188, -1.5534315746620986, -1.5489455020767404, -1.5434945479860764, -1.5370347007239313, -1.5294376353715546, -1.520922386790197, -1.5113985100839482, -1.500802886601115, -1.489112998170655, -1.476436595901733, -1.4629128095026969, -1.4482735437798897, -1.4324750953781047, -1.4156544407617726, -1.3978632359272256, -1.379164117537873, -1.3594729104093741, -1.338854069517887, -1.3174162136375809, -1.2950734397593529, -1.2718005613031935, -1.2475018200738293, -1.222114773089378, -1.1956845421905695, -1.1683312889715065, -1.1400918752586882, -1.1109330453910746, -1.0807979180579286, -1.0497013532477706, -1.0176818927261646, -0.9848424393070525, -0.9511002397354156, -0.9164746469011515, -0.8811610482569449, -0.8453232642491839, -0.8087197633742776, -0.7713472665982428, -0.7332115491042396, -0.6944374620609445, -0.6549667087764962, -0.61491765594223, -0.5742702499720254, -0.5330799142538872, -0.49149181669432485, -0.44939100323500886, -0.4068094182540697, -0.3637756921600702, -0.32039366569664895, -0.27668423093728833, -0.2325585378599056, -0.1881242713936047, -0.14343532492122085, -0.09841342630797349, -0.05318396629009572, -0.007778203703063706, 0.037888578843603145, 0.0835645441319387, 0.1291328110717774, 0.174692421774496, 0.2201820615628005, 0.2654758756324694, 0.3105256963574227, 0.35516125637112544, 0.3994239189990918, 0.443317274066338, 0.4867545746612377, 0.529794969288718, 0.5724983150986037, 0.614835086095289, 0.6567249035804821, 0.6980823860130082, 0.7388681240145577, 0.7791175686141738, 0.8187790107785694, 0.8578637075786224, 0.8961097692823188, 0.933587684318689, 0.970252722319667, 1.0060624578163153, 1.0409559795973644, 1.0750150550219852, 1.1080955927726204, 1.1403994488120033, 1.1718592060312634, 1.202344492515665, 1.2318712631764503, 1.2604128500536769, 1.2880684447194835, 1.3147726589155488, 1.3406180290260339, 1.3654306137015437, 1.3892679533125056, 1.4121105120998054, 1.4340123365625757, 1.4548921589915917, 1.4747689432805104, 1.493852520686139, 1.5121039243756613, 1.529335698147163, 1.5455484769275547, 1.5607666074434836, 1.5750655654274666, 1.5884767399939748, 1.6009556839302461, 1.6123942223460697, 1.622766826019898, 1.6319922024656905, 1.640283838793657, 1.647724542875745, 1.6540855164806987, 1.6594541685657538, 1.6637666930117225, 1.6669527955608585, 1.6690097537885966, 1.6700286581740944, 1.6700762030365774, 1.6691205653890904, 1.6671094680873164, 1.6639740657710094, 1.6597548024714017, 1.654570937692219, 1.6483939416465316, 1.6410913682804082, 1.6327118679268275, 1.6234702134309398, 1.6133045912937252, 1.6023190496095616, 1.59051043417667, 1.5776578106262897, 1.5638797674392284, 1.549193197454323, 1.5335426741477447, 1.5167642343627252, 1.4989029652078425, 1.48000527338053, 1.460246213624076, 1.4394395904080963, 1.4176504691062373, 1.3948610434409123, 1.3710625281155817, 1.3464034449109772, 1.3208418967252533, 1.294407423242404, 1.2670605182097963, 1.2386801242819427, 1.2092525110982533, 1.178937242572723, 1.1477198033019056, 1.1156251983361327, 1.0827039859821743, 1.0489295774710665, 1.0143037472752992, 0.9788943373566412, 0.9426974658075432, 0.9056756827594726, 0.8678977584292102, 0.8293867046566882, 0.7902089899237691, 0.7503508229388829, 0.7097848684746264, 0.6685520130216434, 0.6266234559921223, 0.5840363740001554, 0.540895269986826, 0.4972326166946779, 0.45292510157463894, 0.4081521366739885, 0.3629582997133612, 0.317347716207189, 0.27128149519501066, 0.22497880259982383, 0.17839909444454816, 0.13148502264095796, 0.08430835736211545, 0.036935393095280274, -0.010523538993300309, -0.05806070058284875, -0.1055206358178247, -0.15294003754686694, -0.2000785505061913, -0.24701813804998804, -0.29381593310261317, -0.34030338125057524, -0.386562669931547, -0.43253640905407553, -0.4780649755482538, -0.5231327893654127, -0.567625428668602, -0.6116840831587845, -0.6553593758017334, -0.6983965691263829, -0.7406682320894898, -0.7823477580814061, -0.8234201169621753, -0.863850939515334, -0.9038436672167199, -0.9432327024612741, -0.9818106884871183, -1.019574520811454, -1.056499839841614, -1.0925735385514477, -1.1278651779967217, -1.1623250656027566, -1.1960078111339918, -1.2288369138382602, -1.260787336553164, -1.291917356130933, -1.3221663936293881, -1.351452781564988, -1.3797909477440755, -1.4069835217735216, -1.4330896002242572, -1.4582383100961114, -1.4824069691650723, -1.5056512705621015, -1.5278908282916652, -1.5491919163359011, -1.5694309175342671, -1.5886014245496995, -1.606825764033043, -1.6241758604929524, -1.6406423037806928, -1.6562730534982626, -1.670926253468177, -1.6845396188572799, -1.697217491882897, -1.708943336851971, -1.7196460813483923, -1.7293865668223434, -1.7381059066380933, -1.7457094552596877, -1.7522496991112952, -1.7578991755048239, -1.7625979436475094, -1.7662849045272446, -1.7690421205949338, -1.7708198341071946, -1.7715809104762401, -1.7714253235393507, -1.7703115545744308, -1.7682438728164567, -1.7650969309611406, -1.7609713639810616, -1.7559976742438026, -1.7502068629948464, -1.7435535094636212, -1.7358852060103707, -1.7272004142441664, -1.717439140118811, -1.7068324455877693, -1.695192471710229, -1.682630524158734, -1.6691859736447374, -1.6546986381802233, -1.6392472451033195, -1.6227834126472256, -1.6052532833573059, -1.5868629870469309, -1.5674905364821168, -1.5471402585338883, -1.525761070296538, -1.5032569489977148, -1.4798898013064012, -1.455666986364947, -1.4303542267731468, -1.4038970221032032, -1.3764203007654758, -1.347941651858964, -1.3185945298849013, -1.2883929706779587, -1.257145728750618, -1.224853277385279, -1.1916916000616407, -1.1575946976604503, -1.1225803640596186, -1.0867173222145314, -1.0499342232954314, -1.0122468906258908, -0.9737706398921974, -0.9345633836497308, -0.8945644017143487, -0.8538350939591968, -0.812364508627216, -0.770077575667084, -0.7270198308543432, -0.683356069142936, -0.6391411480006056, -0.5943047757497597, -0.548942108835246, -0.5030428375131616, -0.45664817194481483, -0.4098082655292932, -0.36252652747225095, -0.3149542361917241, -0.26714390214289, -0.21907095413316185, -0.1707109398335388, -0.12215299742564509, -0.07339051147737234, -0.024552326333738824, 0.024375051757179186, 0.07335558089172371, 0.12220573958168739, 0.17088938194580308, 0.21942396121997954, 0.2677882716412837, 0.31595679323722087, 0.3639570043154373, 0.41173019202152217, 0.45908988989225075, 0.5059283295228092, 0.5522851897896854, 0.5980555579336506, 0.643380361137865, 0.6881307383299263, 0.7324024943621088, 0.7761268641041678, 0.8191755787733004, 0.8616926930456178, 0.90350170832448, 0.9446413807208004, 0.984945377528334, 1.024343854563136, 1.062924993664159, 1.10063789261897, 1.1374627818572842, 1.173441050823817, 1.2084757696482884, 1.2426417855893344, 1.2759153645011563, 1.3081555453838645, 1.3395012183790855, 1.3698281357670152, 1.3991065927646056, 1.4273484994241752, 1.4546892081121359, 1.4810512918246133, 1.5062968053917423, 1.530478367038903, 1.5536297760908677, 1.575770994816069, 1.596940452725668, 1.6171549938576268, 1.6363266095776297, 1.654505105475613, 1.6716618807263326, 1.687861628107269, 1.7031376227900963, 1.7175096398476675, 1.7310123159233917, 1.7435407461354877, 1.7550545022901878, 1.7656954421543727, 1.7754366992099344, 1.784154170387418, 1.7919508193910278, 1.798846703092068, 1.8049748662370633, 1.8100014852165198, 1.8140273157457667, 1.8171508660834519, 1.819263237955933, 1.820458260461291, 1.8208329583846676, 1.8201592126126203, 1.818626411587246, 1.8162464813852475, 1.813186979584254, 1.8092354582928365, 1.804429485681512, 1.7986591060832458, 1.7919564907874364, 1.7843167795278572, 1.7756920351534087, 1.7661256578649016, 1.7554108284193755, 1.7437614604505953]

X2=[-0.09977663269622994, -0.18637920607847616, -0.2802548189440778, -0.3816302465809914, -0.47365082891729726, -0.5563041460996364, -0.6588331189292511, -0.7284918746963244, -0.8194087557621386, -0.9107458603205243, -1.0138033456452993, -1.1064439870579537, -1.202883118683563, -1.2753429076900118, -1.3733116143655948, -1.4655446020234035, -1.579498743002227, -1.6635837248126382, -1.7593206141327624, -1.8493313744028217, -1.956856446805509, -2.055202712046305, -2.1573461182824274, -2.2602615911564627, -2.3306368187838173, -2.4186683422777286, -2.5122525982172, -2.6127240168348083, -2.6941815551040116, -2.783182903257781, -2.8568953980793377, -2.9286810001635506, -2.9965842919651644, -3.0825814041952366, -3.1565603534666997, -3.2408338268213797, -3.3259733810490135, -3.383806801030833, -3.447690358756802, -3.5050912710881, -3.5666622441798794, -3.6547871720579366, -3.7308997345578594, -3.8057932014662224, -3.8648469022624834, -3.9106642526971367, -3.9668009632769747, -4.02244689875616, -4.086534906431815, -4.1212778976140285, -4.161705760873663, -4.200258614283668, -4.209416056636962, -4.232480862313943, -4.239933257397443, -4.247091836517683, -4.270883959517389, -4.277283795537417, -4.286465805689522, -4.291327904604263, -4.300015237577684, -4.308095324775667, -4.302221901904422, -4.263420496543198, -4.242022319033012, -4.225627755740977, -4.1756139983025635, -4.146829597902059, -4.130843305687254, -4.099934089377427, -4.0467137449921, -4.004820720032468, -3.953530320736377, -3.89936800115729, -3.8381656283655246, -3.7726950150396314, -3.705301291878292, -3.6329496268851686, -3.5701738329785613, -3.4930327069146343, -3.4212599117593605, -3.346502409569182, -3.2604214390290625, -3.1862298436513155, -3.1152972435316877, -3.0536634641981464, -2.9760292306792446, -2.8747806262685613, -2.8004042058112684, -2.722442871488796, -2.6488652117120783, -2.556322481509404, -2.4695416080269674, -2.3910258931961987, -2.3121394901865613, -2.199652580813279, -2.1035409122903124, -2.0174036846615326, -1.924999927032838, -1.848424834174919, -1.7544159680819, -1.6638204647493449, -1.5725950275878058, -1.4737736850519743, -1.371756991792053, -1.2694398535858888, -1.1571920250534418, -1.0685602208780154, -0.9650883929496351, -0.8663343720617318, -0.7696739632304155, -0.6633064057933618, -0.5799235240290607, -0.487759314800605, -0.37860506318918113, -0.29251676079836275, -0.19657974545590948, -0.1208731469972013, -0.024372603167513336, 0.07340361955397434, 0.16680469122038574, 0.26810758883818714, 0.3608835823651073, 0.44772058025266165, 0.5505523599505416, 0.6448673714312966, 0.7468272749616007, 0.8570226000820467, 0.9406119329785407, 1.0553391969366648, 1.1596593261188803, 1.2687353176055012, 1.3543981102449174, 1.455229055796002, 1.57534951092817, 1.677879588474005, 1.7786751905683884, 1.8725245603780332, 1.9723688369941517, 2.0659482857321603, 2.151466753930005, 2.233010527956849, 2.3257830455902737, 2.4290089428916746, 2.526986459242133, 2.6363229643350237, 2.740299502540199, 2.8265693168583863, 2.9135305305288424, 3.0083631583921204, 3.1062068006582533, 3.20786682600502, 3.287242464132403, 3.370415701175403, 3.46335201824343, 3.5431898627593608, 3.5867789302499076, 3.6574377723221034, 3.7379524907393415, 3.8096408554083863, 3.8820150115775354, 3.9483213549771756, 4.004390860075271, 4.058162703206163, 4.124061613611341, 4.164240507687656, 4.209015363158027, 4.257702373476846, 4.30219546696251, 4.342137989773918, 4.373189359776689, 4.4065883020836525, 4.4430977089901615, 4.464130483966263, 4.488649777239501, 4.524783547375624, 4.53478079339629, 4.564546158706967, 4.569720560053708, 4.561776454066138, 4.5442573397623045, 4.548754213370196, 4.525732939741348, 4.50849799830635, 4.46590111928598, 4.427069330244909, 4.393708421701846, 4.3470382604938225, 4.305404336443574, 4.26565166888246, 4.229934086229474, 4.185387202112856, 4.13308876217108, 4.0727802720339925, 4.022686940531283, 3.9673470364145547, 3.8945800032963307, 3.8382346350342775, 3.7497475403857936, 3.6751493249298015, 3.5818503432987128, 3.492942824309508, 3.40333794749212, 3.3197150338179338, 3.217296372542599, 3.1491876029121593, 3.0541843127411505, 2.9567193893463886, 2.856024806039614, 2.765972906955377, 2.6652340344220513, 2.5786942047434773, 2.483703253064564, 2.382886332091467, 2.286931315181727, 2.1886470964491433, 2.09589014036718, 1.9860398715786016, 1.8968314529235117, 1.8242875968864523, 1.7261646269453785, 1.6246504583262795, 1.5255256267210908, 1.4260603818301454, 1.3305512857096713, 1.2474576337772791, 1.1432711187994238, 1.0426101554461702, 0.9366281016632285, 0.8220429713560049, 0.7393977033590601, 0.640853698490512, 0.5400951998150759, 0.43531486196811214, 0.32836651315907045, 0.2081927760399705, 0.10601274327203804, 0.0021938893726906137, -0.09110089895041115, -0.19867252141013747, -0.30270796509683323, -0.42099830191476056, -0.515027841780818, -0.614117039388453, -0.7280969353461654, -0.8374146275949608, -0.9310602254355741, -1.0234909534709296, -1.1124939929387396, -1.1882164772010952, -1.278896576178879, -1.3845684731508565, -1.4754563401241796, -1.5668669121802303, -1.6708464837349928, -1.783293023833245, -1.8863184973587948, -1.9907683654654473, -2.074045666472648, -2.178569640440494, -2.275807418342194, -2.3809372480571978, -2.476686002086266, -2.560436361940365, -2.6473414647287403, -2.737673559105709, -2.832628737509468, -2.938926700060425, -3.0289545817840318, -3.127213573199431, -3.2068575823135337, -3.2911626603679243, -3.3761762526560335, -3.4707238922623507, -3.5462530303325273, -3.6180184000496496, -3.7039347792980526, -3.7840428113999938, -3.85596944663338, -3.9258985375080884, -3.9862259267871334, -4.055433057486559, -4.121409128706712, -4.191570298762948, -4.252198769109777, -4.326696793299348, -4.3596547933383105, -4.423476339459577, -4.481637408993866, -4.5144406725593536, -4.560810888910214, -4.60027987766545, -4.629958230093313, -4.655340866842168, -4.683167622454181, -4.7105762115569725, -4.732337459497426, -4.740169922403474, -4.750992935209568, -4.746464206296408, -4.743717476400496, -4.724079000944588, -4.693294832511391, -4.677475412448674, -4.6511067497102925, -4.622016413566798, -4.592930576363753, -4.556217657255549, -4.5135445117753585, -4.456758729714059, -4.400171106487466, -4.360406734206837, -4.310064398667506, -4.235105073011982, -4.158307984816132, -4.104650521693462, -4.036449239616949, -3.9859258504930675, -3.931637534888014, -3.858777519192602, -3.7742571558198623, -3.693717008859662, -3.6047421233671284, -3.5278172872076152, -3.444971387914772, -3.3597634678427992, -3.286178439959118, -3.1902244922423244, -3.1076686945765326, -3.019923193868726, -2.9349596467874237, -2.8334128822931306, -2.7270524887265872, -2.6125283060176, -2.509364333122235, -2.4213633295222854, -2.3202675953276475, -2.2196823896436784, -2.122232981803129, -2.0320756434471234, -1.9217753864417333, -1.8123482504607096, -1.733534408594676, -1.6413440016712242, -1.5624891992605072, -1.4700686241879628, -1.360362193091193, -1.2603677184542073, -1.1777976732785076, -1.073353401084053, -0.9737578419950408, -0.880669345091246, -0.7671424702902353, -0.6570561147857107, -0.5609840947766465, -0.47561986137516193, -0.3711657299335336, -0.26975914848305477, -0.17966061521742063, -0.07837098904904251, 0.022274040405024294, 0.11031858204834265, 0.20300737859738538, 0.30945875052001387, 0.418137810186963, 0.5053337704164619, 0.5886102549400427, 0.67827930306483, 0.7645155964813706, 0.8704522052028525, 0.9717673441807466, 1.0701566272715026, 1.1646681233365621, 1.250543662019506, 1.3465320853233194, 1.441284073202337, 1.5502310928341405, 1.6403119271497697, 1.7501681885967317, 1.848335175469947, 1.9316229609327307, 2.0340745326228302, 2.131860135255169, 2.2473178194103607, 2.34843743891006, 2.4216516552267215, 2.5211188296505993, 2.636750496675305, 2.745836806480939, 2.8442053181539357, 2.951672089561023, 3.023732576016286, 3.112084213133599, 3.2287958634389575, 3.322792160566293, 3.407298813604411, 3.500361416937971, 3.5920046168711717, 3.672399161964927, 3.7756481875934043, 3.8530723033471777, 3.921371558832099, 4.001878497838832, 4.074849384574109, 4.145464534855724, 4.22294599323376, 4.293527802472887, 4.370647905883479, 4.422622962474039, 4.484959249528723, 4.5370709440416155, 4.587962503164403, 4.640140585716146, 4.6858618424797, 4.7297832129016015, 4.763439463398119, 4.783486895044042, 4.809129883348771, 4.835345607255898, 4.852403561115966, 4.875837850021379, 4.891340010992148, 4.882017081452127, 4.8989843007093645, 4.886922972062122, 4.870963459602845, 4.860686882926173, 4.833361953287128, 4.813005618204494, 4.793301225977855, 4.774214679541055, 4.745107458451353, 4.682266602343486, 4.641549019329501, 4.5844388587308496, 4.528342906442087, 4.476370060317893, 4.413925081474426, 4.365385462971629, 4.314564922298965, 4.243848337149951, 4.18374862599977, 4.116585415795335, 4.040757621080187, 3.9470104840235916, 3.8560014021146465, 3.773421879937872, 3.6894337448808447, 3.595184072305558, 3.5152630261283817, 3.411473322142915, 3.3302847349709293, 3.2262472466537546, 3.1401126224849074, 3.033643607077272, 2.9392670284125884, 2.8236776525675102, 2.730340128196518, 2.6417839585499805, 2.5315799419043503, 2.4254582245188985, 2.3091881888747072, 2.215596461781972, 2.1146177895216045, 2.0240399390160237, 1.9174463845393832, 1.8215984379292482, 1.7150114685857756, 1.6127815276512747, 1.5259314765868346, 1.4277435410348511, 1.345547667462764, 1.255691358143216, 1.150535848222372, 1.065105350036001, 0.9742215777325645, 0.8713533774138288, 0.7821430838000064, 0.6831121893850235, 0.602162502446041, 0.5166705599840755, 0.3993153219272201, 0.3114268175577065, 0.2168560854546395, 0.10900449703715777, 0.03519644447938661, -0.05698602862516483, -0.16211545332870836, -0.2472226609169819, -0.31490772287872204, -0.39739312390684545, -0.4830382823619717, -0.5743820086058368, -0.6670216345664244, -0.7673278363788112, -0.8659906399356088, -0.9501744222743371, -1.0585191153548115, -1.170587789133908, -1.2623873269496242]

observed_data=[0.8397543296093033, 0.8674706788989737, 1.2223570413617166, 0.6054630549151288, 0.9661738940984473, 1.196210285415006, 0.6808676024412201, 0.5642616772060576, 0.41810956580276615, 0.8892618852698609, 1.5211647876202528, 0.7366539818440978, 0.7350590012322828, 1.5034447498143806, 1.0511864339445653, 1.0222105409682176, 0.8884055926411621, 1.0430436825509082, 0.3687716407507873, 0.5699890197788969, 1.2092490670247125, 0.49925670583423015, 1.0261094129292636, 1.6688993806329746, 0.5577739256369563, 1.4135637050670073, 0.699043584240004, 0.7633365102795646, 1.2888206725823517, 1.1280720462894012, 0.5337210334714664, 1.0312520224072286, 0.22214544337976083, 0.7725062873531399, 0.7534617739505896, 0.3768212803773239, 0.9887913263217857, 0.4014450697529922, 0.6974410722398072, 0.40730105645610676, 0.7343687091657919, 0.802765711746265, 0.541174990269366, 0.4191604018223763, 0.7030018316431574, 0.5277614885756314, 0.23136037739020165, 0.033499576369671935, 0.8280674617618176, 0.7583803425111708, 0.4066722871209326, 0.2938828179240076, 0.5031522714372939, 0.6079087191536535, 0.40528171661420753, 0.36887802012084114, 0.7522251933498515, 0.21956893974260583, 0.07050284907691323, 0.024834040710065553, -0.5233003400414016, -0.2752754277210605, -0.12621857317536556, 0.17059157548974369, 0.33268208367937513, -0.3992063932799776, 0.21261466095045195, -0.2792729845036769, -0.399108284009908, -0.4661855928235924, 0.2000150842806736, -0.7163444024019426, -0.3972959800246361, -0.5440851421575322, -0.7818020268607488, 0.058140619349116074, -0.8299776762907599, -0.8119569068974017, -0.7058254501222286, -1.030882601933092, -0.8511898669030415, -1.096162201893183, -1.3231448617417942, -0.6372236811396433, -0.7814731418402787, -0.8818139109526985, -0.9019412463642065, -0.3322619547460185, -1.0653562720771645, -1.0768027335465267, -0.7983975382597096, -0.29547787223419364, -0.8171155898522277, -1.0552400300089548, -1.1812324598552788, -1.3992769279684003, -1.1707412497396736, -1.2141368443844647, -1.6252037743884307, -0.6342059860177174, -0.7181620609499682, -0.3274872989874045, -0.6755903076184577, -1.1682623443724394, -0.7205311081824177, -1.6435446581931128, -1.0117230083362536, -0.5974242733181541, -0.841792130397832, -0.8990603178731611, -0.7281122453458531, -0.7146209178789674, -0.7925692048252397, -1.3325476636448228, -0.3622501513326086, -0.6143086728897791, -1.43727644426027, -1.1981771062738988, -1.0327851021646255, -0.5069930398186204, -1.2536388396556437, -1.0062395571508125, -1.109593247786785, -0.8061664804889306, -0.7538646601867136, -1.2899031851700846, -1.1208313141052315, -0.7920148360104979, -1.2183061973091147, -0.7322577633621039, -0.6103765323044698, -1.179826826072464, -0.6869080009929063, -0.9174474142728076, -1.1043740454698798, -1.2021732489620252, -0.8948747071500694, -0.7039151999751729, -0.35637505361025934, -0.9356285899566962, -0.6515467172905635, -0.34744366251335956, -0.9131987094770327, -0.5270778594932614, -0.8660611556484209, -1.2336321180424663, -0.6942844534115554, -0.840982920167272, -0.7230076153682241, -1.298189919490144, -1.1125728866888571, -1.1970608118605552, -0.775935490073691, -0.7406055667927095, -0.8919563277659349, -1.1550754790006486, -1.0018389114994355, -0.32822461659680996, -0.20130547589049297, -1.2095963407535262, -0.3219341671358255, -0.26443118058677, -1.0997514239969348, -0.4703095569631289, -0.06839045324679727, -0.3264163618638093, -0.10167912123101985, -0.5242921896686705, -0.30970692701794905, -0.6182002717420888, -0.3353757922269511, 0.2744986610772276, -0.4710229948535187, -0.2178045008795033, 0.07729309564547043, -0.2801836558465563, -0.10357043544843254, -0.07313558550578465, 0.143290888927858, 0.3076830219043978, -0.43141213430769415, 0.03318725887511967, 0.28868587686429986, 0.2139394456053348, 0.4936742426483254, 0.06343104152437723, 0.4350344548353875, 0.265704642015951, 0.6840180497734452, 0.16598329653022104, 0.45105123848290374, 0.3259348228131053, 0.7566913779165867, 0.18161844660895965, 0.5395303125417072, 0.7212547642349093, 0.748579826173792, 0.8554004057455186, 0.7168851003488197, 0.7843612505745864, 0.7792704042583344, 0.6221264820325094, 1.281425830156751, 0.5712909283099488, 1.062645612270868, 1.3410477779932055, 1.0608262592799607, 0.7884274661034887, 0.7920321708657618, 0.6445345276441965, 0.48239567523342186, 1.4578811206469449, 0.6783499246485503, 1.387170387109642, 0.9543468907400992, 0.7958253121920674, 1.5550878485152566, 0.62079987395926, 1.1138427311101462, 1.4249227753286526, 1.158062932109884, 0.615715019110637, 0.9614013639554431, 1.0927986291710876, 0.5674065451257153, 1.3562308616925147, 1.3960210132664663, 0.8099065824830263, 1.3411725358523399, 0.9610813930203718, 1.0412408984134833, 0.6528159647752056, 1.2835659891388953, 1.0202770159946055, 0.9881798219936667, 0.8615396773165978, 0.9214238072577571, 0.4763608146059992, 1.0690367546144208, 0.8234946498406368, 1.1265934648830411, 0.9964904650613491, 0.5480592170741804, 0.6099532256422113, 0.5674350516216291, 0.5684515699233781, 1.217725083961147, 1.2208336686895942, 0.7002216095571361, 1.1226387758000391, 1.1122105806930098, 1.3679086177189201, 0.7486884194015911, 1.5954905998186408, 1.681883935349466, 1.0300084652698112, 0.98291793312377, 0.5819822379206969, 1.2193358193983965, 1.0890280566842183, 0.7612128323777387, 0.6383971156998638, 1.0332158855819595, 0.8222312337726452, 0.5939056476582276, 1.0698451389084145, 1.1618341378769492, 1.1177562827980803, 0.9728903044960491, 0.6405143294454851, 1.2967934160254377, 1.2261940404625062, 0.6956443892346484, 0.70819920603982, 1.5887197998635565, 0.6507956881449275, 0.7924147210100307, 0.517351989731751, 0.8433831194093524, 0.38026931179342166, 0.3193159258692731, -0.18306320013948618, 0.5036294483114887, 0.6203045342470418, 0.8000416453288886, 0.5664054631933264, 0.6629982880992572, 0.7145601926301844, 0.6633735433400633, 0.8949778826735856, 0.46293032612400176, 0.4260339051406192, 0.3615456637911794, 0.1250312332472066, -0.5850305119421094, -0.05921385403858012, 0.41289583130562707, 0.2250386552032078, 0.006584731132049552, 0.08914221541314538, -0.06352380290712346, 0.011959967049949699, -0.13268393951286245, -0.7927153519680643, 0.22112222715629132, -0.19185738229882604, -0.2523183608154981, -0.11169482639431333, -0.20732060308542088, -0.2035643988106276, -0.7416219468693193, -0.2394785219513032, -0.7514110024801481, -0.27800924716410025, -0.436989747252471, -0.5846973181273647, -0.2943015123561451, -1.195793378912226, -0.5950526265776039, -0.7102568506143455, -0.7600442912575488, -0.8042608921818718, -0.5881142373458794, -1.0657539127586428, -0.5554372478465992, -1.4945574746969537, -1.6189064230525032, -0.722059991068773, -1.1626206967318657, -1.2598327003076149, -1.0922976624565097, -1.3021928055824623, -0.6684694041391841, -0.9147269402143148, -0.7011314772872261, -0.9891393505698756, -0.9261073257607095, -0.8712040016490529, -1.5481875313314557, -1.1423457575917813, -0.6409922215831169, -1.1694066580970661, -0.4647732048692663, -0.9767441320804108, -0.31430433475506536, -0.7165662753268704, -0.9336527004180797, -0.7067719147001308, -1.2072571413446358, -0.9505625759885736, -1.217377628144207, -0.7559703791808534, -0.9007980702856941, -0.768045552970118, -1.0079517781319816, -0.942914615794769, -1.135810230224055, -1.0378138905073817, -0.9999290543095731, -0.7236321619762889, -0.16528785200527574, -1.1188911932063796, -0.8232498582727037, -1.2629312355421534, -1.4973899545961697, -0.8706051744567396, -0.6772630628113656, -1.123501873224397, -1.0883816183052675, -0.6336411344314399, -1.0734175512654542, -1.550744411368958, -1.1983117829250551, -1.0346852158344317, -0.8112973909489042, -1.1493313314615363, -0.6491335137373095, -0.5207539126302216, -0.6758559023449737, -1.2451469649008833, -0.9092067383925716, -1.4324011041360152, -1.4362764562377754, -1.2132968513325462, -0.11991379239625166, -0.5190027463355191, -0.9150342512983463, -0.5567370280605974, -0.8180314750501139, -1.5740690113852036, -1.6672311932280863, -1.4415679408874789, -1.3353860421151216, -0.9460891349664747, -1.1050235990734065, -1.0965199888367185, -1.1214879843387426, -1.183673597365837, -1.3175459956496216, -0.9271677247883816, -0.8139723108270094, -1.094808333735769, -1.0962775630348882, -0.39290288753189506, -0.7598367790813803, -1.0220794522047136, -0.9059910925913136, -0.6104480022597356, -0.5660057137218083, -1.215663161627947, -0.9715613647534338, -1.1871547652109253, -0.20550505534660096, -0.5345160488230758, 0.03941204003352938, 0.04215996493563384, -0.49363419454772983, 0.01362867843578075, -0.16464200353371913, 0.44835413556863923, -0.5512993536253906, -0.3518502531993465, 0.05565644448866009, 0.5278957991556282, 0.34225037885320186, -0.1176970955690983, -0.09183057883276782, 1.097835695730604, 0.1061310993837567, 0.28286945046145173, -0.06305461842593446, 0.3846476236345518, 0.8810597887372917, 0.8561606599447732, 0.8777904374478918, 0.5390029769255054, 0.5844024627663511, 0.6497301018389782, 0.6286220582808256, 0.5673458566196748, 1.2259567296899663, 1.221732566956185, 0.429102855768039, 0.36740928912574206, 1.9215532689663546, 0.7626668860401571, 1.0637658367646732, 1.0486739764095674, 0.760814435455274, 0.7474711009923762, 1.2064974463805438, 1.02440916932541, 0.8769203352103275, 0.8532668822713844, 1.2796726767939028, 0.7040634215959707, 1.0942790449540498, 1.0574114683689881, 0.8817087685265014, 1.4550447649668963, 1.0981448850922688, 0.8066805836766279, 1.0078420579204959, 0.6594169659284435, 0.6536472301178351, 1.1737062935469886, 0.5088411719318944, 0.7717077833553536, 2.1241238386693513, 0.7406792356253964, 0.9769710090598581, 0.3212672703300039, 0.9269408198305735, 0.343056052588404, 0.9572588328954413, 1.3988977398009543, 1.0514927779849845, 0.9791917813353922, 0.9725982913739867, 0.986336250370984, 1.0595704080372372, 0.41653308648956866, 0.8405703184716433, 0.9745366641616312, 1.116004605842681, 1.060392395675621, 1.1836812993427772, 0.9893507109339638, 0.6630759273225315, 1.2666762793848032, 0.7673177029239726, 0.36807077757050677, 1.2650608506993681, 0.5730437126484234, 0.8979451153992702, 1.1360141769059662, 0.42950045352202915, 1.1439040740483604, 0.7031012665501722, 0.5569647808900321]


p1=plot(T, sin.(X1), linecolor=:blue, label="Process model estimations")
plot!(T,observed_data, seriestype=:scatter, label="Measurements", color=:green)
xlabel!("t")
ylabel!("Angular position")
p2=plot( X1, X2, linecolor=:blue, label="True", size=(500,500))
xlabel!("Angular velocity")
ylabel!("Angular position")
ppp=plot(p1, p2, layout=(2, 1), size=(1000, 1000))
display(ppp)

Y=observed_data

# Plot the data
# data_Y=add_gauss(X[1, :],0.4)

Turing.setadbackend(:forwarddiff)
@model function fitmb(data)

     # UKF Filter parameters
     DT = 0.01

     σ1 ~ InverseGamma(2, 3)
     Q1 ~ truncated(Normal(3.33333e-9, 1e-10),1e-9,1e-7)#truncated(InverseGamma(3., .05),0,0.1)#InverseGamma(2, 3)
     Q2 ~ truncated(Normal(5.0e-7, 1e-8),1e-8,1e-6)#truncated(InverseGamma(3., .05),0,0.1)#InverseGamma(2, 3)
     Q3 ~ truncated(Normal(5.0e-7, 1e-8),1e-8,1e-6)#truncated(InverseGamma(3., .05),0,0.1)#InverseGamma(2, 3)
     Q4 ~ truncated(Normal(0.0001, 0.00001),1e-5,1e-3)#truncated(InverseGamma(3., .05),0,0.1)#InverseGamma(2, 3)
     Q =[Q1 Q2; Q3 Q4]
     #Q = 0.01 * [DT^3/3 DT^2/2; DT^2/2 DT]
     R ~ truncated(Normal(0.1, 0.01),1e-4,1)#Normal(0.1,1.0) #Uniform(0.0001,0.3)
     # R=R^2

     predicted_m=[]
     g ~ Normal(9.81,0.02) #


     #m11 ~ Uniform(-2,2)
     #m0 = [m11; 0.0]
     m0 = [0.0; 0.0]

     P11 ~ Uniform(0.9,1.2)
     P0 = [P11 0.0; 0.0 1.0]

     m = m0
     P = P0
     # Precompute the UT weights
     n = size(m, 1)
     alpha ~ truncated(Normal(1.0, 0.01),0.5,1.5) #1.0
     beta = 0.0
     kappa = 3.0 - n
     lambda = alpha^2 * (n + kappa) - n
     WM = []#zeros(2 * n + 1)
     WC = []#zeros(2 * n + 1)
     for j in 1:2*n+1
         if j == 1
             wm = lambda / (n + lambda)
             wc = lambda / (n + lambda) + (1 - alpha^2 + beta)
         else
             wm = 1 / (2 * (n + lambda))
             wc = wm
         end
         #WM[j] = wm
         #WC[j] = wc
         append!(WM,  wm)
         append!(WC,  wc)
     end

     # MM = zeros(size(m, 1), length(data))
     # PP = zeros(size(P, 1), size(P, 2), length(data))

     # # run the UKF
     for k in 1:length(data)
         # Form the sigma points for dynamic model
         A = cholesky(Hermitian(P)).L #cholesky(P'P).L
         SX = [zeros(size(m)) A -A]
         SX = sqrt(n + lambda) .* SX .+ repeat(m, 1, size(SX, 2))
         # Propagate through the dynamic model
         HX = hcat(SX[1, :] .+ SX[2, :] .* DT, SX[2, :] .- g .* sin.(SX[1, :]) .* DT)'
         # Compute the predicted mean and covariance
         m = zeros(size(m))
         P = zeros(size(P))
         for i in 1:size(HX, 2)
             m = m .+ WM[i] .* HX[:, i]
         end
         for i in 1:size(HX, 2)
             P = P.+ WC[i] .* (HX[:, i] .- m) * (HX[:, i] .- m)'
         end
         P = P .+ Q
         append!(predicted_m,   m[1]) #save the predicted m to be used in Normal.
         # Form sigma points for measurement step
         A = cholesky(Hermitian(P)).L #cholesky(P).L
         SX = [zeros(size(m)) A -A]
         SX = sqrt(n + lambda) .* SX .+ repeat(m, 1, size(SX, 2))
         HY = sin.(SX[1, :])
         # Compute the updated mean and covariance
         mu = zeros(1,1)
         S = zeros(1,1)
         C = zeros(2, 1)
         for i in 1:size(SX, 2)
             mu= mu .+ WM[i] .* HY[i]'
         end
         for i in 1:size(SX, 2)
             S = S + WC[i] .* (HY[i]'.- mu) * (HY[i]'.- mu)'
             C = C .+ WC[i] .* (SX[:, i] .- m) * (HY[i]' .- mu)'
         end
         # Compute the gain and updated mean and covariance
         S = S.+ R
         K = C / S
         m =m.+  K * (Y[k] .- mu)
         P =P.- K * S * K'
         # MM[:, k] = m
         # PP[:, :, k] = P
     end

     for  i = 1:length(predicted_m)
         data[i] ~ Normal(sin(predicted_m[i]),σ1^2)
     end
end


model = fitmb(Y)

chain = sample(model, NUTS(0.65), 1000; progress=true)
display(chain)

gr();
plot(chain)
nm="chain_"*Dates.format(Dates.now(), "d u yyyy H:m:s")
println(nm)
png(nm)

using CSV, DataFrames

# Convert chain to DataFrame
chain_df = DataFrame(chain)
# Save to CSV
full_path_nm="your_path"
CSV.write(full_path_nm*"chain_bat_UKF"*nm*".csv", chain_df)




# Chains MCMC chain (1000×21×1 Array{Float64, 3}):
#
# Iterations        = 501:1:1500
# Number of chains  = 1
# Samples per chain = 1000
# Wall duration     = 881.07 seconds
# Compute duration  = 881.07 seconds
# parameters        = σ1, Q1, Q2, Q3, Q4, R, g, P11, alpha
# internals         = lp, n_steps, is_accept, acceptance_rate, log_density, hamiltonian_energy, hamiltonian_energy_error, max_hamiltonian_energy_error, tree_depth, numerical_error, step_size, nom_step_size
#
# Summary Statistics
#   parameters      mean       std   naive_se      mcse         ess      rhat   ess_per_sec
#       Symbol   Float64   Float64    Float64   Float64     Float64   Float64       Float64
#
#           σ1    0.5696    0.0098     0.0003    0.0003   1548.8430    0.9999        1.7579
#           Q1    0.0000    0.0000     0.0000    0.0000   1603.7018    0.9990        1.8202
#           Q2    0.0000    0.0000     0.0000    0.0000   1284.0344    0.9990        1.4574
#           Q3    0.0000    0.0000     0.0000    0.0000   1025.5751    0.9991        1.1640
#           Q4    0.0001    0.0000     0.0000    0.0000   1154.1471    0.9990        1.3099
#            R    0.1012    0.0097     0.0003    0.0003   1287.9324    0.9990        1.4618
#            g    9.8116    0.0192     0.0006    0.0005   1544.3130    1.0001        1.7528
#          P11    1.0299    0.0780     0.0025    0.0026   1142.6586    0.9993        1.2969
#        alpha    0.9994    0.0098     0.0003    0.0003    968.7915    0.9993        1.0996
#
# Quantiles
#   parameters      2.5%     25.0%     50.0%     75.0%     97.5%
#       Symbol   Float64   Float64   Float64   Float64   Float64
#
#           σ1    0.5514    0.5627    0.5693    0.5758    0.5890
#           Q1    0.0000    0.0000    0.0000    0.0000    0.0000
#           Q2    0.0000    0.0000    0.0000    0.0000    0.0000
#           Q3    0.0000    0.0000    0.0000    0.0000    0.0000
#           Q4    0.0001    0.0001    0.0001    0.0001    0.0001
#            R    0.0834    0.0946    0.1011    0.1074    0.1208
#            g    9.7721    9.7988    9.8112    9.8242    9.8509
#          P11    0.9063    0.9643    1.0274    1.0874    1.1820
#        alpha    0.9796    0.9923    0.9995    1.0063    1.0175
#
# chain_30 Jan 2024 20:1:806
#
#
#
# Chains MCMC chain (1000×21×1 Array{Float64, 3}):
#
# Iterations        = 501:1:1500
# Number of chains  = 1
# Samples per chain = 1000
# Wall duration     = 1373.68 seconds
# Compute duration  = 1373.68 seconds
# parameters        = σ1, Q1, Q2, Q3, Q4, R, g, P11, alpha
# internals         = lp, n_steps, is_accept, acceptance_rate, log_density, hamiltonian_energy, hamiltonian_energy_error, max_hamiltonian_energy_error, tree_depth, numerical_error, step_size, nom_step_size
#
# Summary Statistics
#   parameters      mean       std   naive_se      mcse         ess      rhat   ess_per_sec
#       Symbol   Float64   Float64    Float64   Float64     Float64   Float64       Float64
#
#           σ1    0.5692    0.0092     0.0003    0.0003   1038.3673    0.9990        0.7559
#           Q1    0.0000    0.0000     0.0000    0.0000   1335.7710    0.9994        0.9724
#           Q2    0.0000    0.0000     0.0000    0.0000   1075.5818    0.9990        0.7830
#           Q3    0.0000    0.0000     0.0000    0.0000   1295.4349    0.9990        0.9430
#           Q4    0.0001    0.0000     0.0000    0.0000    907.7666    0.9991        0.6608
#            R    0.1009    0.0100     0.0003    0.0003   1017.0857    0.9990        0.7404
#            g    9.8112    0.0188     0.0006    0.0006   1042.5633    0.9990        0.7590
#          P11    1.0254    0.0760     0.0024    0.0022   1148.6758    0.9990        0.8362
#        alpha    0.9994    0.0102     0.0003    0.0003   1017.5206    1.0006        0.7407
#
# Quantiles
#   parameters      2.5%     25.0%     50.0%     75.0%     97.5%
#       Symbol   Float64   Float64   Float64   Float64   Float64
#
#           σ1    0.5515    0.5626    0.5692    0.5754    0.5863
#           Q1    0.0000    0.0000    0.0000    0.0000    0.0000
#           Q2    0.0000    0.0000    0.0000    0.0000    0.0000
#           Q3    0.0000    0.0000    0.0000    0.0000    0.0000
#           Q4    0.0001    0.0001    0.0001    0.0001    0.0001
#            R    0.0809    0.0943    0.1007    0.1075    0.1212
#            g    9.7742    9.7988    9.8110    9.8236    9.8477
#          P11    0.9057    0.9621    1.0189    1.0847    1.1716
#        alpha    0.9786    0.9927    0.9993    1.0064    1.0189
#
# chain_30 Jan 2024 20:1:736
#
#




DT = 0.01
g = 9.81
Q = 0.01 * [DT^3/3 DT^2/2; DT^2/2 DT]
R = 0.1
m0 = [0.0; 0.0]
P0 = [1.0 0.0; 0.0 1.0]

steps = 500

# Generate simulated data
QL = cholesky(Q).L
T = zeros(steps)
X = zeros(2, steps)
Y = zeros(steps)
t = 0.0
x = [1.5; 0.0]
for k in 1:steps
    x = [x[1] + x[2] * DT; x[2] - g * sin(x[1]) * DT]
    w = QL* randn(2)
    x += w
    y = sin(x[1]) + sqrt(R) * randn()   #Example 5.2 (Measurement model for noisy pendulum) in Simo's Book.
    t += DT
    T[k] = t
    X[:, k] = x
    Y[k] = y
end



chain_bat_UKF = CSV.read("./chain_bat_UKFchain_30 Jan 2024 20:1:806.csv", DataFrame)
println(mean(chain_bat_UKF[:,4])," : Q1")
println(mean(chain_bat_UKF[:,5])," : Q2")
println(mean(chain_bat_UKF[:,6])," : Q3")
println(mean(chain_bat_UKF[:,7])," : Q4")
println(mean(chain_bat_UKF[:,8])," : R")
println(mean(chain_bat_UKF[:,9])," : g")
println(mean(chain_bat_UKF[:,10])," : P11")
println(mean(chain_bat_UKF[:,11])," : alpha")

println(std(chain_bat_UKF[:,4])," : Q1")
println(std(chain_bat_UKF[:,5])," : Q2")
println(std(chain_bat_UKF[:,6])," : Q3")
println(std(chain_bat_UKF[:,7])," : Q4")
println(std(chain_bat_UKF[:,8])," : R")
println(std(chain_bat_UKF[:,9])," : g")
println(std(chain_bat_UKF[:,10])," : P11")
println(std(chain_bat_UKF[:,11])," : alpha")

g=mean(chain_bat_UKF[:,9])
m0 = [0.0; 0.0]
P0 = [mean(chain_bat_UKF[:,10]) 0.0; 0.0 1.0]

# UKF Filter
m = m0
P = P0


R = mean(chain_bat_UKF[:,8])
Q = 0.01 * [mean(chain_bat_UKF[:,4]) mean(chain_bat_UKF[:,5]); mean(chain_bat_UKF[:,6]) mean(chain_bat_UKF[:,7])]


# Precompute the UT weights
n = size(m, 1)
alpha = mean(chain_bat_UKF[:,11])#1.0
beta = 0.0
kappa = 3.0 - n

lambda = alpha^2 * (n + kappa) - n
WM = zeros(2 * n + 1)
WC = zeros(2 * n + 1)

for j in 1:2*n+1
    if j == 1
        wm = lambda / (n + lambda)
        wc = lambda / (n + lambda) + (1 - alpha^2 + beta)
    else
        wm = 1 / (2 * (n + lambda))
        wc = wm
    end
    WM[j] = wm
    WC[j] = wc
end

# Do the filtering
MM = zeros(size(m, 1), length(Y))
PP = zeros(size(P, 1), size(P, 2), length(Y))


for k in 1:length(Y)
    # Form the sigma points for dynamic model
    A = cholesky(Hermitian(P)).L #cholesky(P'P).L
    SX = [zeros(size(m)) A -A]
    SX = sqrt(n + lambda) .* SX .+ repeat(m, 1, size(SX, 2))

    # Propagate through the dynamic model
    HX = hcat(SX[1, :] .+ SX[2, :] .* DT, SX[2, :] .- g .* sin.(SX[1, :]) .* DT)'

    # Compute the predicted mean and covariance
    m = zeros(size(m))
    P = zeros(size(P))
    for i in 1:size(HX, 2)
        m .+= WM[i] .* HX[:, i]
    end
    for i in 1:size(HX, 2)
        P .+= WC[i] .* (HX[:, i] .- m) * (HX[:, i] .- m)'
    end
    P .+= Q

    # Form sigma points for measurement step
    A = cholesky(Hermitian(P)).L #cholesky(P).L
    SX = [zeros(size(m)) A -A]
    SX = sqrt(n + lambda) .* SX .+ repeat(m, 1, size(SX, 2))
    HY = sin.(SX[1, :])

    # Compute the updated mean and covariance
    mu = zeros(1,1)
    S = zeros(1,1)
    C = zeros(2, 1)

    for i in 1:size(SX, 2)
        mu .+= WM[i] .* HY[i]'
    end

    for i in 1:size(SX, 2)
        S = S + WC[i] .* (HY[i]'.- mu) * (HY[i]'.- mu)'
        C .+= WC[i] .* (SX[:, i] .- m) * (HY[i]' .- mu)'
    end
    S .+= R

     println(m)

    # Compute the gain and updated mean and covariance
    K = C / S
    m .+= K * (Y[k] .- mu)
    P .-= K * S * K'

    MM[:, k] = m
    PP[:, :, k] = P
end

# lws=6
# gr( xtickfontsize=7, ytickfontsize=7, xguidefontsize=9, yguidefontsize=9, legendfontsize=8);
# p1=plot(T, Y, seriestype=:scatter, label="Measurements", color=:green)
# plot!(T, X1, linecolor=:blue, label="True angle",lw=lws)
# plot!(T, MM[1, :], color=:red, label="UKF estimate",lw=lws)
# xlabel!("t")
# ylabel!(L"Pendulum~angle~X_{1,k}")
# display(p1)
# png("BAT_UKF")
#
#
# # Calculate RMSE
# rmse_ukf = sqrt(mean((X1 .- MM[1, :]).^2))
# println("RMSE of UKF: ", rmse_ukf)

lws=6
gr( xtickfontsize=7, ytickfontsize=7, xguidefontsize=9, yguidefontsize=9, legendfontsize=8);
p1=plot(T, Y, seriestype=:scatter, label="Measurements", color=:green)
plot!(T, X[1, :], linecolor=:blue, label="True angle",lw=lws)
plot!(T, MM[1, :], color=:red, label="UKF estimate",lw=lws)
xlabel!("t")
ylabel!(L"Pendulum~angle~X_{1,k}")
display(p1)
png("BAT_UKF")


# Calculate RMSE
rmse_ukf = sqrt(mean((X[1, :] .- MM[1, :]).^2))
println("RMSE of UKF: ", rmse_ukf)
