using LinearAlgebra, Random, Distributions, Plots, Infiltrator
using DifferentialEquations
using ReverseDiff, Turing ,StatsPlots, Noise,Dates
using CSV, DataFrames
using Measures
using LaTeXStrings, Turing
# https://github.com/EEA-sensors/Bayesian-Filtering-and-Smoothing/blob/main/matlab/examples/pendulum_CKF.m


# Simulation parameters
DT = 0.01
g = 9.81
Q = 0.01 * [DT^3/3 DT^2/2; DT^2/2 DT]
R = 0.1
m0 = [0.0; 0.0]
P0 = [1.0 0.0; 0.0 1.0]

steps = 500

# Generate simulated data
QL = cholesky(Q).L
T = zeros(steps)
X = zeros(2, steps)
Y = zeros(steps)
t = 0.0
x = [1.5; 0.0]
# for k in 1:steps
#     x = [x[1] + x[2] * DT; x[2] - g * sin(x[1]) * DT]
#     w = QL* randn(2)
#     x += w
#     y = sin(x[1]) + sqrt(R) * randn()   #Example 5.2 (Measurement model for noisy pendulum) in Simo's Book.
#     t += DT
#     T[k] = t
#     X[:, k] = x
#     Y[k] = y
# end


p1=plot(T, sin.(X[1, :]), linecolor=:blue, label="Process model estimations")
plot!(T, Y, seriestype=:scatter, label="Measurements", color=:green)
xlabel!("t")
ylabel!("Angular position")
p2=plot( X[1, :], X[2, :], linecolor=:blue, label="True", size=(500,500))
xlabel!("Angular velocity")
ylabel!("Angular position")
ppp=plot(p1, p2, layout=(2, 1), size=(1000, 1000))
display(ppp)



T=[0.01, 0.02, 0.03, 0.04, 0.05, 0.060000000000000005, 0.07, 0.08, 0.09, 0.09999999999999999, 0.10999999999999999, 0.11999999999999998, 0.12999999999999998, 0.13999999999999999, 0.15, 0.16, 0.17, 0.18000000000000002, 0.19000000000000003, 0.20000000000000004, 0.21000000000000005, 0.22000000000000006, 0.23000000000000007, 0.24000000000000007, 0.25000000000000006, 0.26000000000000006, 0.2700000000000001, 0.2800000000000001, 0.2900000000000001, 0.3000000000000001, 0.3100000000000001, 0.3200000000000001, 0.3300000000000001, 0.34000000000000014, 0.35000000000000014, 0.36000000000000015, 0.37000000000000016, 0.38000000000000017, 0.3900000000000002, 0.4000000000000002, 0.4100000000000002, 0.4200000000000002, 0.4300000000000002, 0.4400000000000002, 0.45000000000000023, 0.46000000000000024, 0.47000000000000025, 0.48000000000000026, 0.49000000000000027, 0.5000000000000002, 0.5100000000000002, 0.5200000000000002, 0.5300000000000002, 0.5400000000000003, 0.5500000000000003, 0.5600000000000003, 0.5700000000000003, 0.5800000000000003, 0.5900000000000003, 0.6000000000000003, 0.6100000000000003, 0.6200000000000003, 0.6300000000000003, 0.6400000000000003, 0.6500000000000004, 0.6600000000000004, 0.6700000000000004, 0.6800000000000004, 0.6900000000000004, 0.7000000000000004, 0.7100000000000004, 0.7200000000000004, 0.7300000000000004, 0.7400000000000004, 0.7500000000000004, 0.7600000000000005, 0.7700000000000005, 0.7800000000000005, 0.7900000000000005, 0.8000000000000005, 0.8100000000000005, 0.8200000000000005, 0.8300000000000005, 0.8400000000000005, 0.8500000000000005, 0.8600000000000005, 0.8700000000000006, 0.8800000000000006, 0.8900000000000006, 0.9000000000000006, 0.9100000000000006, 0.9200000000000006, 0.9300000000000006, 0.9400000000000006, 0.9500000000000006, 0.9600000000000006, 0.9700000000000006, 0.9800000000000006, 0.9900000000000007, 1.0000000000000007, 1.0100000000000007, 1.0200000000000007, 1.0300000000000007, 1.0400000000000007, 1.0500000000000007, 1.0600000000000007, 1.0700000000000007, 1.0800000000000007, 1.0900000000000007, 1.1000000000000008, 1.1100000000000008, 1.1200000000000008, 1.1300000000000008, 1.1400000000000008, 1.1500000000000008, 1.1600000000000008, 1.1700000000000008, 1.1800000000000008, 1.1900000000000008, 1.2000000000000008, 1.2100000000000009, 1.2200000000000009, 1.2300000000000009, 1.2400000000000009, 1.2500000000000009, 1.260000000000001, 1.270000000000001, 1.280000000000001, 1.290000000000001, 1.300000000000001, 1.310000000000001, 1.320000000000001, 1.330000000000001, 1.340000000000001, 1.350000000000001, 1.360000000000001, 1.370000000000001, 1.380000000000001, 1.390000000000001, 1.400000000000001, 1.410000000000001, 1.420000000000001, 1.430000000000001, 1.440000000000001, 1.450000000000001, 1.460000000000001, 1.470000000000001, 1.480000000000001, 1.490000000000001, 1.500000000000001, 1.5100000000000011, 1.5200000000000011, 1.5300000000000011, 1.5400000000000011, 1.5500000000000012, 1.5600000000000012, 1.5700000000000012, 1.5800000000000012, 1.5900000000000012, 1.6000000000000012, 1.6100000000000012, 1.6200000000000012, 1.6300000000000012, 1.6400000000000012, 1.6500000000000012, 1.6600000000000013, 1.6700000000000013, 1.6800000000000013, 1.6900000000000013, 1.7000000000000013, 1.7100000000000013, 1.7200000000000013, 1.7300000000000013, 1.7400000000000013, 1.7500000000000013, 1.7600000000000013, 1.7700000000000014, 1.7800000000000014, 1.7900000000000014, 1.8000000000000014, 1.8100000000000014, 1.8200000000000014, 1.8300000000000014, 1.8400000000000014, 1.8500000000000014, 1.8600000000000014, 1.8700000000000014, 1.8800000000000014, 1.8900000000000015, 1.9000000000000015, 1.9100000000000015, 1.9200000000000015, 1.9300000000000015, 1.9400000000000015, 1.9500000000000015, 1.9600000000000015, 1.9700000000000015, 1.9800000000000015, 1.9900000000000015, 2.0000000000000013, 2.010000000000001, 2.020000000000001, 2.0300000000000007, 2.0400000000000005, 2.0500000000000003, 2.06, 2.07, 2.0799999999999996, 2.0899999999999994, 2.099999999999999, 2.109999999999999, 2.1199999999999988, 2.1299999999999986, 2.1399999999999983, 2.149999999999998, 2.159999999999998, 2.1699999999999977, 2.1799999999999975, 2.1899999999999973, 2.199999999999997, 2.209999999999997, 2.2199999999999966, 2.2299999999999964, 2.239999999999996, 2.249999999999996, 2.259999999999996, 2.2699999999999956, 2.2799999999999954, 2.289999999999995, 2.299999999999995, 2.3099999999999947, 2.3199999999999945, 2.3299999999999943, 2.339999999999994, 2.349999999999994, 2.3599999999999937, 2.3699999999999934, 2.3799999999999932, 2.389999999999993, 2.399999999999993, 2.4099999999999926, 2.4199999999999924, 2.429999999999992, 2.439999999999992, 2.4499999999999917, 2.4599999999999915, 2.4699999999999913, 2.479999999999991, 2.489999999999991, 2.4999999999999907, 2.5099999999999905, 2.5199999999999902, 2.52999999999999, 2.53999999999999, 2.5499999999999896, 2.5599999999999894, 2.569999999999989, 2.579999999999989, 2.5899999999999888, 2.5999999999999885, 2.6099999999999883, 2.619999999999988, 2.629999999999988, 2.6399999999999877, 2.6499999999999875, 2.6599999999999873, 2.669999999999987, 2.679999999999987, 2.6899999999999866, 2.6999999999999864, 2.709999999999986, 2.719999999999986, 2.7299999999999858, 2.7399999999999856, 2.7499999999999853, 2.759999999999985, 2.769999999999985, 2.7799999999999847, 2.7899999999999845, 2.7999999999999843, 2.809999999999984, 2.819999999999984, 2.8299999999999836, 2.8399999999999834, 2.849999999999983, 2.859999999999983, 2.869999999999983, 2.8799999999999826, 2.8899999999999824, 2.899999999999982, 2.909999999999982, 2.9199999999999817, 2.9299999999999815, 2.9399999999999813, 2.949999999999981, 2.959999999999981, 2.9699999999999807, 2.9799999999999804, 2.9899999999999802, 2.99999999999998, 3.00999999999998, 3.0199999999999796, 3.0299999999999794, 3.039999999999979, 3.049999999999979, 3.0599999999999787, 3.0699999999999785, 3.0799999999999783, 3.089999999999978, 3.099999999999978, 3.1099999999999777, 3.1199999999999775, 3.1299999999999772, 3.139999999999977, 3.149999999999977, 3.1599999999999766, 3.1699999999999764, 3.179999999999976, 3.189999999999976, 3.1999999999999758, 3.2099999999999755, 3.2199999999999753, 3.229999999999975, 3.239999999999975, 3.2499999999999747, 3.2599999999999745, 3.2699999999999743, 3.279999999999974, 3.289999999999974, 3.2999999999999736, 3.3099999999999734, 3.319999999999973, 3.329999999999973, 3.3399999999999728, 3.3499999999999726, 3.3599999999999723, 3.369999999999972, 3.379999999999972, 3.3899999999999717, 3.3999999999999715, 3.4099999999999713, 3.419999999999971, 3.429999999999971, 3.4399999999999706, 3.4499999999999704, 3.45999999999997, 3.46999999999997, 3.47999999999997, 3.4899999999999696, 3.4999999999999694, 3.509999999999969, 3.519999999999969, 3.5299999999999687, 3.5399999999999685, 3.5499999999999683, 3.559999999999968, 3.569999999999968, 3.5799999999999677, 3.5899999999999674, 3.5999999999999672, 3.609999999999967, 3.619999999999967, 3.6299999999999666, 3.6399999999999664, 3.649999999999966, 3.659999999999966, 3.6699999999999657, 3.6799999999999655, 3.6899999999999653, 3.699999999999965, 3.709999999999965, 3.7199999999999647, 3.7299999999999645, 3.7399999999999642, 3.749999999999964, 3.759999999999964, 3.7699999999999636, 3.7799999999999634, 3.789999999999963, 3.799999999999963, 3.8099999999999627, 3.8199999999999625, 3.8299999999999623, 3.839999999999962, 3.849999999999962, 3.8599999999999617, 3.8699999999999615, 3.8799999999999613, 3.889999999999961, 3.899999999999961, 3.9099999999999606, 3.9199999999999604, 3.92999999999996, 3.93999999999996, 3.9499999999999598, 3.9599999999999596, 3.9699999999999593, 3.979999999999959, 3.989999999999959, 3.9999999999999587, 4.009999999999959, 4.019999999999959, 4.0299999999999585, 4.039999999999958, 4.049999999999958, 4.059999999999958, 4.069999999999958, 4.079999999999957, 4.089999999999957, 4.099999999999957, 4.109999999999957, 4.119999999999957, 4.129999999999956, 4.139999999999956, 4.149999999999956, 4.159999999999956, 4.1699999999999555, 4.179999999999955, 4.189999999999955, 4.199999999999955, 4.209999999999955, 4.2199999999999545, 4.229999999999954, 4.239999999999954, 4.249999999999954, 4.259999999999954, 4.269999999999953, 4.279999999999953, 4.289999999999953, 4.299999999999953, 4.3099999999999525, 4.319999999999952, 4.329999999999952, 4.339999999999952, 4.349999999999952, 4.3599999999999515, 4.369999999999951, 4.379999999999951, 4.389999999999951, 4.399999999999951, 4.40999999999995, 4.41999999999995, 4.42999999999995, 4.43999999999995, 4.4499999999999496, 4.459999999999949, 4.469999999999949, 4.479999999999949, 4.489999999999949, 4.4999999999999485, 4.509999999999948, 4.519999999999948, 4.529999999999948, 4.539999999999948, 4.549999999999947, 4.559999999999947, 4.569999999999947, 4.579999999999947, 4.589999999999947, 4.599999999999946, 4.609999999999946, 4.619999999999946, 4.629999999999946, 4.6399999999999455, 4.649999999999945, 4.659999999999945, 4.669999999999945, 4.679999999999945, 4.689999999999944, 4.699999999999944, 4.709999999999944, 4.719999999999944, 4.729999999999944, 4.739999999999943, 4.749999999999943, 4.759999999999943, 4.769999999999943, 4.7799999999999425, 4.789999999999942, 4.799999999999942, 4.809999999999942, 4.819999999999942, 4.8299999999999415, 4.839999999999941, 4.849999999999941, 4.859999999999941, 4.869999999999941, 4.87999999999994, 4.88999999999994, 4.89999999999994, 4.90999999999994, 4.9199999999999395, 4.929999999999939, 4.939999999999939, 4.949999999999939, 4.959999999999939, 4.9699999999999385, 4.979999999999938, 4.989999999999938, 4.999999999999938]

X1=[1.50006606162746, 1.4991622654875827, 1.4972791206474687, 1.4944073678503973, 1.4906191115910805, 1.4858233703549049, 1.4800633363895426, 1.4733740842100893, 1.4657596329422384, 1.4571829031089958, 1.4475369561732876, 1.4367563508067245, 1.4250550461134408, 1.4124501753302745, 1.3989540578468385, 1.38448429542667, 1.3689738908937217, 1.352480860672205, 1.3350349422031442, 1.316816830431583, 1.297748977418251, 1.277628633501494, 1.256516543740579, 1.2345276927300475, 1.2115492888640826, 1.1874924722582714, 1.162445512796628, 1.136379993678671, 1.109429387034147, 1.0816555278721665, 1.053090153698785, 1.0236982300472939, 0.9934066414844891, 0.9621859207326324, 0.9302337080759924, 0.8974695455885574, 0.8638906657070914, 0.8294598923871177, 0.7943740083191364, 0.7586305784941448, 0.7220528001767633, 0.68481540530296, 0.6470397489826645, 0.6086583926959532, 0.5695653657617425, 0.5298456357626956, 0.4896638917233109, 0.44886503400510486, 0.407529835934062, 0.36579749172363063, 0.32379611173998235, 0.28147749027671676, 0.23898611583965923, 0.19632246945419707, 0.15335552763997026, 0.11025258157336099, 0.06692247141834003, 0.02365174403493364, -0.019668047346627596, -0.06298423843342606, -0.10629606595074732, -0.14968850346037288, -0.1929903268608998, -0.23608667901440716, -0.2791292622775293, -0.32205184953152705, -0.3647319985718577, -0.40697894373838006, -0.4488916257880002, -0.49045253048165977, -0.5316209853076931, -0.5723545778660549, -0.6125790273731887, -0.6522539766936263, -0.6913494101332974, -0.7297844141565928, -0.7676930873684327, -0.804993114666749, -0.8415548194003937, -0.8774599255725526, -0.9126694962216272, -0.9472255690648598, -0.9810545388544877, -1.013959569150664, -1.045975795525632, -1.0771923572652222, -1.1075412223702545, -1.1370806292617497, -1.1655622155344032, -1.1931137589678187, -1.2197956517249402, -1.2456102977115546, -1.2704558451946857, -1.2944799914303875, -1.3176426835355548, -1.339943447727134, -1.3613907972992747, -1.3818683636374682, -1.4015031609528712, -1.4202836537661025, -1.4380499864661822, -1.4548201412721795, -1.4706748968471346, -1.4856825075327156, -1.4997347068490814, -1.5127791116053926, -1.5248639120669065, -1.5360090188409352, -1.5461096191910413, -1.5552842218130616, -1.5635489686478241, -1.5707994957151519, -1.5771596516351885, -1.5826298432874404, -1.58704811362258, -1.5905811397489902, -1.593078505474251, -1.5944228142729144, -1.594733163528927, -1.5938918962489323, -1.5920897620339223, -1.589203963229757, -1.585201063707138, -1.5802292910449751, -1.5743062248466075, -1.5674379659434448, -1.5595181314511046, -1.5506660617656949, -1.5408761534157396, -1.5301400895304735, -1.518345621563922, -1.5053161671399584, -1.4911342886085122, -1.4760104489697965, -1.4598762920758617, -1.442777109401116, -1.4245992189917904, -1.4054461678863086, -1.3852854987822636, -1.364089709454251, -1.3420963813574236, -1.3191967530476547, -1.295252014995587, -1.2704103992467843, -1.2445541613931153, -1.2176861275440598, -1.1899177406433854, -1.1612850003097406, -1.1318304686951701, -1.1014973127021541, -1.0702864829644512, -1.0382487339970645, -1.0053569854510298, -0.9716615797389804, -0.9371180323622381, -0.901842204219348, -0.8659395110981299, -0.8292260819387121, -0.7916597790260582, -0.7533429012320918, -0.7144072934374999, -0.6748470749866239, -0.6346362415862257, -0.5938738561033435, -0.5526016863862938, -0.5107188342473608, -0.46837404002589283, -0.4256188706690452, -0.38258377467218246, -0.339274478100302, -0.2956297335261483, -0.251641097982712, -0.20728123716911936, -0.16251466326699668, -0.11752130204887896, -0.07232454554921061, -0.026945294473495016, 0.01849308245908007, 0.0639443531033663, 0.10941795268426023, 0.15487198684663675, 0.20041580843979853, 0.2459322284259841, 0.291468411149394, 0.33684467781078503, 0.3820250016526095, 0.42686326914864087, 0.4713256631617382, 0.515422332814435, 0.5591637092239875, 0.6025292381844702, 0.6453013861360306, 0.6874720133774316, 0.7289631117382941, 0.769747666550313, 0.809864030354645, 0.8492298567143679, 0.8877121242573226, 0.9255526147811218, 0.9627248510875213, 0.999127025802713, 1.0346381100099737, 1.0694101599815187, 1.1032527526485758, 1.1362765116807299, 1.1684519680430832, 1.1996988239180633, 1.2299821359361478, 1.259176858942308, 1.2874297473049015, 1.3146701193262378, 1.3409318918842161, 1.3662950562963758, 1.3907492679255813, 1.414229229718086, 1.4368601744750826, 1.4585900133539673, 1.479406828659497, 1.4992921025733634, 1.5180900595739462, 1.535662412683977, 1.5521975702429816, 1.5677886826255474, 1.5822586686207771, 1.5956904199899526, 1.6080963127797194, 1.6195130005544869, 1.6299476967481494, 1.6395278312292882, 1.6483280236442444, 1.656269281134618, 1.66320670185622, 1.6691971402471897, 1.6741907661161903, 1.6780752944343682, 1.6808325841844312, 1.6826998233785992, 1.6836979408382913, 1.6837296217722528, 1.682706104916353, 1.6806429136702765, 1.6775570490917753, 1.6733615375704913, 1.668124571755363, 1.6619622813482768, 1.6548832991396432, 1.6468650066666084, 1.6378629792302366, 1.6278558076076923, 1.6169085302971185, 1.6050630836958983, 1.592360778360281, 1.578790245382026, 1.5642153859260601, 1.5486124817056397, 1.5319897180764834, 1.514419738526882, 1.4958270321309495, 1.4761724013017938, 1.4555017601486615, 1.4338948255998023, 1.4113496622413917, 1.3877916455283068, 1.3634400874788843, 1.3382372179197288, 1.3121559272320495, 1.285223178274539, 1.257375055133402, 1.2285317419979895, 1.1988470570374223, 1.1682248093867091, 1.1365801434020513, 1.1041571596875228, 1.070758757819318, 1.0366308163275335, 1.0016843661556274, 0.9660849257261039, 0.9296725649195492, 0.8925271241653723, 0.8547076685282554, 0.8160107087380797, 0.776524085363668, 0.7364305676075239, 0.6956893106162155, 0.6543292690444192, 0.6124473032325898, 0.5700083655608775, 0.5268817165010807, 0.48304765289494583, 0.43865379866343795, 0.39377457604511157, 0.34837066057119115, 0.30254209102272345, 0.2564125955585502, 0.20994840392108713, 0.1632430692512296, 0.11635153465881536, 0.06933279189001385, 0.022243513639016103, -0.024811427675431673, -0.07194120314811824, -0.11909788565764876, -0.16616436851013347, -0.21316111917113145, -0.2601090895782998, -0.3069430436310324, -0.35358939556613056, -0.3999684792616394, -0.44614027558331937, -0.4919135390724824, -0.5372390731878468, -0.5820659299743393, -0.6262383518238904, -0.6699061881648469, -0.7128647210081722, -0.755133110717594, -0.7966423374281982, -0.8374457320414253, -0.8776176217268391, -0.9170399679496088, -0.9557669566701192, -0.9936804290652902, -1.030762283395968, -1.067000716786377, -1.1024944105026222, -1.1370278461278296, -1.170564809065827, -1.203185579936007, -1.2349091802686372, -1.265677098045709, -1.2953244171803115, -1.3239174916211494, -1.3516366379901759, -1.3783502555756089, -1.4040129785809272, -1.4287594686123473, -1.452435933576383, -1.4751404870249025, -1.496854665189712, -1.5175810021550156, -1.5372893200108835, -1.5560195258547527, -1.5737805614274698, -1.5904302423785632, -1.606148443546035, -1.620876469648514, -1.6345664451128468, -1.647157389330037, -1.6587816427460007, -1.6694702676857482, -1.6791742311130848, -1.6879237364942148, -1.695710976466685, -1.7025342705360618, -1.7083060999564332, -1.7131032123178505, -1.7169354578328466, -1.7198212506672579, -1.72165296113788, -1.7225840543383932, -1.7225613435309823, -1.7214040284552832, -1.7192391857178475, -1.7161623963490318, -1.7121125804758723, -1.707114293521322, -1.7011181543138294, -1.6939984737788891, -1.6857885756626567, -1.6765794105522298, -1.6664004423284406, -1.6552665016506158, -1.6430926114053963, -1.6297924682599239, -1.6153623253205822, -1.5998831781281602, -1.583404954385427, -1.5659388667472929, -1.5475161014230199, -1.5282669721208, -1.507964222494297, -1.4866533907625503, -1.4644786068363187, -1.4414244127183167, -1.417589625497338, -1.3928042927356348, -1.3669580428837536, -1.3401154522287788, -1.3123309149145155, -1.2836920472165065, -1.2542644473489537, -1.223960203458096, -1.192753535359407, -1.160686095430315, -1.1277759850587468, -1.0938443451043731, -1.0590083520936218, -1.023267287999609, -0.9865702814371807, -0.9489878245446695, -0.9105000945916084, -0.8712755709602404, -0.8314391956492563, -0.7908315514542192, -0.7494613334393844, -0.707478871052408, -0.6648009749534077, -0.6215257103266256, -0.5776353297320266, -0.533052932743208, -0.48787376403015087, -0.4422817528128237, -0.39634250823264594, -0.34992259438548334, -0.30314297354961534, -0.2560156633577494, -0.20851168781480459, -0.16080494932288847, -0.11300879099486916, -0.06529116743723026, -0.017650299451131377, 0.030118537484388808, 0.07800668630466433, 0.12590548863739606, 0.17374559250275662, 0.2215838923386322, 0.2691103744479157, 0.31639087468346994, 0.36334056480551424, 0.4100093534142023, 0.45638183716398856, 0.5023340442668481, 0.5479609696836661, 0.5931390412212513, 0.6377128446685653, 0.6818085215018456, 0.725292979981563, 0.7680618139648645, 0.8100805734407965, 0.851497791713749, 0.8921405421622141, 0.9319318558033188, 0.9708647250073934, 1.0090457659241974, 1.046445302336214, 1.0830739636333147, 1.118792767427399, 1.1536838795089814, 1.1878318146943583, 1.221076865778732, 1.2533624674519455, 1.2847883481049427, 1.3154499110557596, 1.345138042016486, 1.373990203537679, 1.4018691791371585, 1.428892189844134, 1.4550697692345143, 1.4802958537358373, 1.5043503450998552, 1.5274015377123344, 1.5493203040343089, 1.5701103235004692, 1.5897760666111913, 1.6086214059221677, 1.6265276157810562, 1.643551958867222, 1.6595277196774263, 1.6743481554398987, 1.688167131286299, 1.7011288791575268, 1.7131735940065191, 1.724283806304474, 1.7345021775475042, 1.7437271723618069, 1.7519879547255757, 1.7593444459845846, 1.7657463892793084, 1.771093005826748, 1.775391201579012, 1.7786515520787096, 1.7810096511709097, 1.782570042545327, 1.783275415413999, 1.783028895164765, 1.7817768276233905, 1.7796166891594958, 1.7764278114893723, 1.7723035725408165, 1.7672748639392595, 1.7614138429866841, 1.7546528555481122, 1.7469406469760127, 1.738165305104913, 1.7282277000129647, 1.7172978192936752, 1.7053224022954276, 1.6923029839002235, 1.6782841002953206, 1.6633968464249853]

X2=[-0.08538636395303269, -0.1876770812005515, -0.2802102185955481, -0.38814113508569864, -0.4695706527775766, -0.5792244991247303, -0.6687075539086417, -0.770025420635783, -0.8648668727395555, -0.9605517531623821, -1.0680598879154493, -1.1710571593244443, -1.2693103080128323, -1.350097259615411, -1.4483667661993411, -1.5470063015221307, -1.652161715782689, -1.7424144268774895, -1.8374992986133756, -1.9071397982645129, -2.0043634876830314, -2.109719928708922, -2.20677515329234, -2.2899592333799634, -2.4007373268298786, -2.5031961531134734, -2.6143660943923663, -2.6992299134765743, -2.7797824706640526, -2.8594465306049233, -2.940144335627597, -3.02039794648919, -3.1198179976124405, -3.203939786685064, -3.2761121365926233, -3.3559547997426553, -3.43265998647967, -3.5192234495372814, -3.5741835272644487, -3.6579900896983135, -3.723109626332741, -3.7794506886382546, -3.835160532797619, -3.904128222914869, -3.9695250720357915, -4.019806056183219, -4.072283705152395, -4.127081520381899, -4.180130088922369, -4.205180086460622, -4.234266849201474, -4.262353425345487, -4.263658160576813, -4.298602340929952, -4.312268963489222, -4.331931182541753, -4.337949426260096, -4.333202144062213, -4.331035558285605, -4.3317388612072705, -4.332973104799128, -4.338045412938617, -4.309386544180694, -4.295332017198272, -4.2870154464082955, -4.270801560804575, -4.236375887098304, -4.189057768562079, -4.155817318150435, -4.115666350778188, -4.0704917498908895, -4.019622924744825, -3.9681558281985914, -3.915439789100652, -3.8393805544298485, -3.7835461816037945, -3.7262595986900915, -3.661430728599063, -3.59238145299867, -3.5178701234740526, -3.4524415239135076, -3.3796598202817316, -3.2962231770510386, -3.198587182456772, -3.1237295242049727, -3.037250562904581, -2.947427435682172, -2.8677351937864026, -2.751776553251141, -2.665708005680892, -2.584471058465035, -2.4824730643253456, -2.3895566798823396, -2.3127181312362612, -2.22334967396443, -2.1422034811974875, -2.0547421861428723, -1.955254780947571, -1.869839568162428, -1.7819823680793323, -1.6722532559294812, -1.5806693522661057, -1.4931014727888452, -1.4054433532025776, -1.30196441124312, -1.2080137465436032, -1.111890447395382, -1.0149278146942744, -0.9154456570544828, -0.8216314885288991, -0.7227021929784051, -0.6329477517090095, -0.5370057579221996, -0.44432042598888555, -0.34820765799794795, -0.25549713824779063, -0.138645189204844, -0.03613943700255586, 0.07362754354081796, 0.18342056596986683, 0.27928957461426535, 0.3993674349130202, 0.49814093533640214, 0.5943064933099864, 0.6911639780230171, 0.7880504645036995, 0.8835509998954044, 0.9853039413402571, 1.0683327935957498, 1.1773461192319807, 1.2915884489682479, 1.4047991906166444, 1.5244630284673093, 1.6095082801774003, 1.708178202254484, 1.8122862699511528, 1.918566338908254, 2.0147922588025176, 2.116707173395188, 2.206270682425859, 2.2875700811275212, 2.391942473281852, 2.490377763672079, 2.576725161977074, 2.6773543533942634, 2.7807624018743438, 2.8612088347868303, 2.947900234962291, 3.0364049731327327, 3.117753459083439, 3.202053311505321, 3.2847910166846046, 3.3753156132872495, 3.4549840625545696, 3.5350857066562114, 3.592964948020847, 3.6649508124831183, 3.7548223363943976, 3.8415240988140327, 3.8955162089960087, 3.955519804914977, 4.025752258497896, 4.079131867184886, 4.130210003244773, 4.185359287824943, 4.243725806297199, 4.2741978152751035, 4.313302384878088, 4.336140996308983, 4.367597584659116, 4.401851287978843, 4.42430548637622, 4.4712959803446655, 4.502677742977326, 4.517263039349176, 4.538230974681595, 4.541580920152353, 4.543826939439173, 4.5475611397924975, 4.540062181118377, 4.540889104048464, 4.541339840256009, 4.550042916915676, 4.532764022263232, 4.509024018581559, 4.48694414118053, 4.44074380729103, 4.409472259203031, 4.372227365722703, 4.329382455265679, 4.281923279387255, 4.217937986159751, 4.1565384580017595, 4.078260152797503, 4.006843571178253, 3.9435039455557055, 3.8586785623577797, 3.7776702894278418, 3.712272496930713, 3.6449262916312803, 3.558144456195348, 3.4705040070011677, 3.3882106383192916, 3.3018548714728717, 3.215992485270003, 3.1239895811514726, 3.034815571673017, 2.9234777759261643, 2.825625556977999, 2.731514219151482, 2.62145882548452, 2.5372919311938293, 2.4363929754580003, 2.3432787360354856, 2.2579444894540277, 2.1718658260116026, 2.0832497712645175, 1.988711840653473, 1.8910447054509036, 1.764504504139853, 1.655545886635925, 1.558179013827533, 1.4558794201792393, 1.351083730847659, 1.244035044537927, 1.14341207454154, 1.0424870027597064, 0.9537058368560588, 0.8728725047785021, 0.793357420092163, 0.6872477020501039, 0.6010173080186897, 0.49987294575341884, 0.4001035837125185, 0.2825723261896178, 0.1819107502471053, 0.09580129707657711, 0.0123436673653216, -0.10143447220912036, -0.20216709284512735, -0.31129559783705246, -0.40876116995894274, -0.5247027364999608, -0.6242045802271154, -0.7112877500556705, -0.8032289942687016, -0.8987001770332258, -1.0036482371316064, -1.0985843351513134, -1.193108888236437, -1.2724869545254638, -1.3579543958343725, -1.4568560878303143, -1.5537625253351246, -1.6641516813094528, -1.7522293220103038, -1.851475847414855, -1.9650988269904086, -2.0677728629327516, -2.1597352924301805, -2.2570225507528336, -2.35463721815977, -2.450713265587705, -2.5232023901463485, -2.608967390646253, -2.7048922693806663, -2.779182418465026, -2.8854850768328415, -2.973512591132294, -3.0571135156076727, -3.158593151378081, -3.2509778565132965, -3.3369139556082876, -3.424387239489034, -3.493941510402049, -3.572982138524183, -3.636972093215163, -3.724231258604153, -3.7825994024650225, -3.8654748802632475, -3.9548614902140975, -4.017524697895535, -4.07770063970076, -4.139531405948644, -4.196632375909315, -4.245329856437633, -4.300843268091517, -4.378781484136855, -4.438216855580759, -4.48614691989693, -4.529082354770116, -4.58384723935446, -4.6084493289515684, -4.648454076327101, -4.678041451441478, -4.688376221940569, -4.701785972957944, -4.7131955747229, -4.705303374660613, -4.709576461204467, -4.717316061600059, -4.705052341823812, -4.694755970415577, -4.694296475700535, -4.674489454000979, -4.661126860184365, -4.638326672474837, -4.608329113632221, -4.587471846406633, -4.535876955908278, -4.48713802501223, -4.415028649670185, -4.367882399349781, -4.303261866070984, -4.227226031050439, -4.157156149202986, -4.077958023832191, -4.01173727077273, -3.9488473874649306, -3.8742603291357707, -3.7913807695157833, -3.7113023209327234, -3.6287829618894207, -3.532719480900609, -3.4621782231865934, -3.3541912244834164, -3.260483122873784, -3.172483562894774, -3.080331732187511, -2.9728887107169855, -2.86117121133102, -2.7762114195028116, -2.6796679453127084, -2.5653039867398517, -2.470559456366409, -2.376901942337111, -2.270400114896488, -2.1758198329084575, -2.0709226328740766, -1.9766090305205792, -1.8673674800341336, -1.7776630402386167, -1.6693425951737255, -1.5722775075124151, -1.4720292766642993, -1.3747526257408451, -1.2540872857750762, -1.160234850651172, -1.0655841115099047, -0.974532102774228, -0.8751369427801827, -0.7793960513173359, -0.6853300206835765, -0.5812679373955016, -0.478622440513795, -0.3769172113527633, -0.28817429872963396, -0.19135176570956428, -0.08962195773498455, 8.328410186152733e-5, 0.10654086498698993, 0.21722468884554572, 0.3052687274579686, 0.4089977841784752, 0.49915992439687845, 0.5973226020000609, 0.6988957176394063, 0.8228360100565266, 0.9218943948014727, 1.0141006522898146, 1.1092490966762516, 1.2104065775170718, 1.3211125971579167, 1.4377928412255196, 1.5483218488630661, 1.644890665788429, 1.7473041432215581, 1.8416370859984024, 1.9293946521435061, 2.0291814402158384, 2.132192108732773, 2.2195153753957753, 2.3100870574659207, 2.392683025198413, 2.4757020453861367, 2.578225313737243, 2.68874884720706, 2.7800206751095837, 2.870960202475925, 2.95810361057327, 3.0241642975066725, 3.129533799184872, 3.2127921631893477, 3.2898741192294603, 3.393217469256732, 3.4802399725117605, 3.5749108872238695, 3.6672154967917474, 3.7491594473286267, 3.846628360155923, 3.9263248944115734, 3.988843795741412, 4.059754156000225, 4.137171044563645, 4.199892642639733, 4.268354897658267, 4.33105831604274, 4.391752502238869, 4.444361072442609, 4.517490047963306, 4.566148781204734, 4.595450090283285, 4.633891937315749, 4.6809957225650844, 4.709928304371885, 4.751168067126752, 4.769261433885672, 4.791538015374719, 4.786044296569409, 4.766443527642525, 4.7678367564466795, 4.789735299734048, 4.790801542710267, 4.779112979992936, 4.778770483531989, 4.764554877340384, 4.731677912379535, 4.700788550565016, 4.663375774214185, 4.6408663697626515, 4.592373550314901, 4.558699699539831, 4.523644675189017, 4.462272905535943, 4.403595398097692, 4.348386053782942, 4.285100496493648, 4.197232809727941, 4.142270305723783, 4.073500693763536, 3.9844205696596373, 3.896498582540251, 3.8166689834184733, 3.7406905340429426, 3.6637878219934006, 3.572755583860207, 3.4811420009747165, 3.4001292457956462, 3.323564035845871, 3.2283721719290748, 3.133956440581347, 3.0684041529783355, 2.962739688827617, 2.8817165545707053, 2.786087116498186, 2.6970223576216177, 2.6109973908169475, 2.5288260629163717, 2.4182345655319235, 2.306472186693966, 2.203206275585098, 2.0891052880043097, 1.9747929531565955, 1.869416871022272, 1.7880168797757758, 1.6942362525207226, 1.603770040963933, 1.4856871537959262, 1.3851357077266457, 1.289766603277629, 1.204172860498155, 1.1075944349834486, 1.0176867114033936, 0.9184199078388096, 0.830108280500476, 0.7317473544830733, 0.645155566493806, 0.5430865932175639, 0.4393982653636378, 0.3267969793246377, 0.23740543038895587, 0.14669653969079088, 0.07113250304214774, -0.01870407364004307, -0.12368916069611105, -0.21593354763467815, -0.31483972648463515, -0.41768111758042353, -0.508713135349383, -0.589949770447003, -0.6807987456467143, -0.7730928741789068, -0.8679371762616614, -0.9907198428089526, -1.0920527391059733, -1.1973842257227536, -1.3010136213623051, -1.401918109714117, -1.4943592835479105, -1.5877169501428874]

observed_data=[1.153065257987697, 0.6005658077155738, 1.1220907515247942, 0.8977658533936168, 0.7148549241713674, 1.1733817807840452, 1.2550829316282865, 1.121390430526263, 0.7941815170456337, 1.0799102275092454, 0.753211232711797, 0.9214871725786462, 1.0682241752920072, 0.637993079267654, 1.2601026750646325, 0.8975700586817351, 0.7977804777780393, 0.7265452559145944, 0.7799160453901355, 1.0598369401042134, 0.9264643053916641, 0.6697573804705734, 0.9507299338599859, 0.9522250938868957, 1.0854889989177674, 0.6312286997447063, 0.943294196214206, 0.9330847154564391, 0.6009596977325915, 0.8725475725169469, 1.4419912486426554, 0.8906795018404466, 0.8070187317166286, 0.6463491605553164, 0.8902995834667273, -0.01743674863237321, 0.40837700008341965, 0.6447596393650579, 0.8864273615467455, 1.0726077161844303, 1.2261897816475695, 0.8211050510927594, 0.7985001050502705, 0.6056659018219154, 0.5041362254507704, -0.31079168448383354, 0.3865388649076018, 0.5869673605601676, -0.12143304816164568, 0.6264868609508973, -0.08011801567796628, 0.8339765130857242, 0.28818855512109803, 0.3640657113196108, -0.06179869183900796, -0.8064524483609428, -0.035376600444910644, 0.086967609746183, -0.251177582965705, 0.6584181040651597, 0.23764498399820277, -0.1711696327782491, -0.19920556554070537, -0.04731117832151957, -0.06650804862086887, -0.4870275506363272, 0.017051625482276067, -0.27105120763110896, -0.22059352752423259, -0.20342038035170656, -0.7601091194030987, -0.9379547201467819, -0.47754968644841966, -0.5515436241097652, -0.6296345881989572, -0.23178002955650928, -0.7330983575326014, -0.6716976080333052, -0.6296023706286248, -0.7226247276325409, -0.2935531019937565, -0.7313005057258373, -0.9388283370743647, -1.1849375407696605, -1.3448460514643052, -0.9361916686688075, -1.0952190949532206, -0.6476281752224449, -0.9054001150701121, -1.2228577557649434, -1.0131091506582288, -0.9030155891298306, -1.1870561353077802, -1.4220383247124115, -0.5741909507200003, -1.275898551926567, -1.3712741872598861, -0.9883484520539203, -0.46150144953768535, -0.9292904939679463, -1.0146622274683037, -0.43475654803948527, -0.9340174759145676, -1.552500407068063, -1.2291108309780405, -1.059909387920886, -1.9174101609211358, -0.8572640606827484, -0.8850550656632644, -0.7968945593461992, -0.8104859379264135, -0.9188860715640771, -0.7262041710962497, -1.0621927146696954, -0.7443893962823321, -1.2256407177997006, -0.7963332668045944, -0.6012981010713571, -0.3967201712939541, -0.5257648267575515, -0.9755594076091542, -0.3954686577909009, -1.5977766307474228, -1.3353711767630023, -0.854125838302446, -0.9060743913339355, -0.5556524459454357, -0.9831868054337741, -0.6394906094560958, -1.0332341803235225, -1.0511328688774018, -1.400803963245693, -1.0094332498598735, -0.8136478307126056, -0.4651014182965675, -1.0939487975964646, -0.8843283692321693, -0.285337131632979, -1.6429644631038527, -0.9773102779977698, -0.6841090230896266, -0.6748514773214183, -0.5885310852400925, -1.1589285521962196, -1.027288238656233, -1.1839042631465826, -1.053341503169153, -0.8382541189988804, -0.49751522915522267, -1.0929384191128608, -1.3672987918331934, -0.974299934576826, -0.827902721398981, -0.5469582823393931, -0.8345243057053681, -0.6277924540916018, -0.4787307491724895, -0.8245605385690558, -0.14768330748975944, -0.33041812144864197, -0.8530063467567691, -0.7383069266763211, -0.40083900536291217, -0.4496403494136622, -0.13022714499069382, -0.27236696761108875, -0.26001578054088587, -0.175810704309527, -0.33363281488822655, -0.5856631801885981, 0.36529266968291957, 0.08087970360461447, -0.10023555344484951, -0.3628227714406197, -0.2733672436782346, -0.1747422565381495, 0.24025207291270026, 0.06942379503988454, 0.30339924604362933, 0.10852348057736898, -0.432954265070899, 0.034598573382418646, 0.7489340195776258, 0.08937136857762198, 0.8348802688575672, 0.41242118608551104, 1.0320115832973686, 0.306996734417062, 0.12338761099219647, 0.1784682230482736, 0.7147953138368127, 0.7320195786211554, 1.0034739198779397, 0.08971662748266318, 0.5620463536060659, 0.2648560866178469, 1.230880098821581, 0.6304986700938084, 1.086597744116974, 0.5701173308710434, 0.8260336917940879, 0.9102883297551385, 1.0167133621983293, 1.0353917548927938, 0.22096802635808488, 0.9524825315013883, 1.1321917874361478, 1.0345138195194377, 1.2103318974118091, 1.2074491464177013, 1.4016555395272032, 0.38512442789619883, 1.0304082932581395, 1.4152492906969454, 1.0041409352641517, 1.311871678796734, 1.1629928605569977, 1.4362255968628683, 1.290160778632111, 1.820317359025002, 2.042116575515998, 1.004612629406737, 1.2358992167805305, 0.7637993648424017, 1.1396920232379388, 1.1241312507017915, 0.6293568208189637, 0.5012821072584229, 0.575676596992165, 1.0525861940101617, 0.9676795046213627, 1.4551184816851248, 1.3687165290490462, 1.1493677858270959, 1.3867730770326507, 0.8503241854726553, 1.0188738769869259, 1.6686378977351906, 0.5911311405614006, 0.8528250713320448, 1.5004263458412488, 0.45590835492657, 0.9551940649912014, 0.8281306482808768, 1.1193832590194641, 0.4853877981801853, 1.5350951871420349, 1.1577292854193726, 1.2470463809453376, 1.3062895625614988, 1.2970350687427135, 0.5110077880048676, 1.1553997467483414, 1.1189641566938988, 1.3942564360783352, 1.0158258501277202, 1.37989559097079, 1.4135004287446638, 0.999216704591639, 0.8104867677128519, 1.2189722337928897, 0.8349457781326545, 0.9277618015567356, 1.415580746558741, 1.0100744004751723, 1.109245174227997, 0.6649922166318996, 1.198158820829415, 0.7769054565530074, 0.39871415741422667, 1.266098567791394, 0.9748038681337152, 0.8545726816116956, 1.6915825765918326, 0.8053545382711615, 0.7490526085141513, 0.830850171472999, 0.5270340144470204, 1.004300948425665, 0.7367628766948665, 0.10470874045929823, 0.6712109627683848, 0.5494475568035697, 1.2481798697468247, 0.29147600678262586, 0.08451067506624821, 0.31542210133205095, 0.2787247433423697, -0.08708674554003554, 0.19314484482811414, -0.29079566982606964, 0.6234754196204818, 0.09692970430012926, -0.13244670352206495, 0.22208311146529233, 0.8490298822124974, 0.7424647242364657, 0.1081383298581656, 0.11108984944755074, 0.11691496106661105, 0.3000883469513186, -0.34595401426514893, 0.6404144826880901, -0.42450123101047743, 0.04618907839480113, -0.3555167224716102, -0.5518965869445285, -0.5450971710710568, -0.4419921363375102, -0.3834673214548591, -0.6658576212001706, -0.570599638616009, -0.40688880243404074, -0.39044543160934764, -1.2279286553455877, -0.721765954788144, -0.6197546906738716, -0.6161838380518201, -0.8102886039774282, -0.46473645460567226, -1.2445204525546794, -0.3437845048252517, -0.8398500498881782, -0.9337898149688187, -1.3271118923664413, -1.2327908218864265, -0.9478075693967491, -1.1303972118652634, -0.6004984971166408, -0.4085929275571485, -0.7733935200426838, -0.9628981282473611, -0.6319751510429187, -0.6969691916503246, -0.7836153082173436, -1.2070637547066192, -1.778306069823907, -1.090896455539228, -0.48391670631242045, -1.508712604196743, -1.2382587565333039, -1.389460260037418, -0.8218190538753023, -0.8573104767038995, -1.2607508999774382, -0.5139703072317963, -0.8993948856078468, -0.46364547948361357, -1.291070772128641, -0.44097697777671707, -0.7785148203821676, -0.6566894407185269, -1.2294542573649134, -0.7768098895949228, -0.6684814468573423, -1.3159393131909427, -1.1158830355793092, -1.3355142726442402, -1.0012884702810758, -1.1089268566275488, -0.6946343265077273, -0.7072150492618682, -1.1644547426729182, -0.6676304660352887, -1.0916118562415285, -1.21501560020645, -1.089932777300028, -0.7570053422634448, -1.312486405689385, -0.8190299477602818, -0.9066033161988307, -1.1795915544709674, -0.5095308780376309, -0.699830617131665, -0.8311383735904837, -0.7876530178801331, -1.021514188058054, -0.8227715376137392, -1.2241180499684634, -0.7029438962217818, -0.8989530218304411, -1.2001780416126497, -0.5593722498815465, -1.0427047278849382, -1.036381798741801, -0.9158365171115131, -1.1925409504938989, -1.4646126384195157, -1.2038859716998838, -1.3598591182256832, -0.6406757528159452, -0.901557738897348, -1.2252374236450227, -0.4382122053663035, -1.1577109557775975, -0.7980802575614161, -0.9026795447606195, -1.3244087970907816, -0.7030740604987509, -0.6560116227846893, -1.2883442949837294, -0.5579429677905847, -0.4734877416407696, -1.0534719988003096, -0.6333492661964532, 0.22130929899982144, -0.9535103227637787, -0.5927769617649975, -0.5831805509788858, -0.4030577424008804, -0.6841159643159818, -0.2739839009169572, -1.019398267006459, -0.3241794037949273, -0.10725167408525305, 0.08911527780663231, -0.3660340773567864, 0.10013109286682709, -0.3717801654131361, 0.19115542612967948, -0.6667157610857188, -0.20324231543572296, -0.42837292008738637, 0.20040260169986523, 0.38205160470974264, 0.4292453728607608, 0.42851034714093716, 0.44021334335026885, -0.006155252484085327, 0.5015609147012974, 0.36662534503046706, 0.41646096308209757, 0.6486570672853337, 1.3074245350304254, 0.895186901215878, 0.6168592589539165, 0.7174228385038183, 0.8317519536337017, 0.3822370088544979, 0.6872967763027507, 1.1405179084782255, 0.6544943164541015, 1.0656485182842248, 0.5685039889516164, 0.7309658086300487, 0.6319408452992599, 0.6939032444164674, 1.2131683473644839, 0.5550652325180402, 0.668672904604226, 0.5440126255888906, 0.7054852952535751, 1.8258411751423353, 1.2757321091088796, 1.1651885842885334, 0.768946846935199, 0.9592217874184019, 0.7801738061285539, 0.13743079928301294, 1.035832969866625, 0.7568449715822814, 0.4323638709135258, 0.6075840807207746, 1.1004802739145207, 1.1978308649930747, 0.9411816783243021, 1.2242533402519131, 1.3543230440426943, 0.5454331681191205, 0.47593105815962866, 0.9424723657697072, 1.3878465063587737, 0.7567814404412355, 1.2015251037795527, 1.356785068336055, 1.2730545205195503, 1.0371780335291063, 1.1957167176513157, 1.0387946588047805, 1.1871659535163697, 0.8496199083580191, 0.9589014851260208, 1.2479200408355067, 1.0654704642543107, 0.33986349197446053, 0.6672663078644392, 1.035005846307369, 0.44779653773705674, 1.4254534487105621, 0.8828312277420783, 0.7593348338024487, 1.0864529141052082, 0.46772419151828404, 1.174695634568923, 0.7927862191349484, 1.3747892658637673, 0.9226076836675365, 1.0367811489924685, 0.8646888087441277, 1.3839380513724586]

p1=plot(T, sin.(X1), linecolor=:blue, label="Process model estimations")
plot!(T,observed_data, seriestype=:scatter, label="Measurements", color=:green)
xlabel!("t")
ylabel!("Angular position")
p2=plot( X1, X2, linecolor=:blue, label="True", size=(500,500))
xlabel!("Angular velocity")
ylabel!("Angular position")
ppp=plot(p1, p2, layout=(2, 1), size=(1000, 1000))
display(ppp)

Y=observed_data

# Plot the data
# data_Y=add_gauss(X[1, :],0.4)

Turing.setadbackend(:forwarddiff)
@model function fitmb(data)

     # CKF Filter parameters
     DT = 0.01

     σ1 ~ InverseGamma(2, 3)
     #Q1 ~ truncated(Normal(3.33333e-9, 1e-10),1e-9,1e-7)#truncated(InverseGamma(3., .05),0,0.1)#InverseGamma(2, 3)
     #Q2 ~ truncated(Normal(5.0e-7, 1e-8),1e-8,1e-6)#truncated(InverseGamma(3., .05),0,0.1)#InverseGamma(2, 3)
     #Q3 ~ truncated(Normal(5.0e-7, 1e-8),1e-8,1e-6)#truncated(InverseGamma(3., .05),0,0.1)#InverseGamma(2, 3)
     #Q4 ~ truncated(Normal(0.0001, 0.00001),1e-5,1e-3)#truncated(InverseGamma(3., .05),0,0.1)#InverseGamma(2, 3)
     dt ~ truncated(Normal(0.01, 0.001),1e-3,1e-2)#truncated(InverseGamma(3., .05),0,0.1)#InverseGamma(2, 3)
     Q = 0.01 * [dt^3/3 dt^2/2; dt^2/2 dt]
     #Q =[Q1 Q2; Q3 Q4]
     #Q = 0.01 * [DT^3/3 DT^2/2; DT^2/2 DT]
     R ~ truncated(Normal(0.1, 0.01),1e-4,1)#Normal(0.1,1.0) #Uniform(0.0001,0.3)
    # R=R^2

     predicted_m=[]
     g ~ Normal(9.81,0.02) #

     #P11 ~ Normal(1,0.002) #

     m0 = [0.0; 0.0]
     P0 = [1.0 0.0; 0.0 1.0]

     # CKF Filter
     m = m0
     P = P0

     # Precompute the UT weights
     n = size(m, 1)

     XI = sqrt(n) * [Matrix{Float64}(I, n, n) -Matrix{Float64}(I, n, n)]
     W = ones(2 * n) / (2 * n)

     # # run the CKF
     for k in 1:length(Y)
         # Form the sigma points for dynamic model
         SX = repeat(m, 1, 2 * n) + cholesky(Hermitian(P)).L * XI

         # Propagate through the dynamic model
         HX = hcat(SX[1, :] .+ SX[2, :] .* DT, SX[2, :] .- g .* sin.(SX[1, :]) .* DT)'

         # Compute the predicted mean and covariance
         m = zeros(size(m))
         P = zeros(size(P))
         for i in 1:size(HX, 2)
             m = m .+  W[i] .* HX[:, i]
         end
         for i in 1:size(HX, 2)
             P = P .+ W[i] .* (HX[:, i] .- m) * (HX[:, i] .- m)'
         end
         P =P .+ Q

         append!(predicted_m,   m[1]) #save the predicted m to be used in Normal.

         # Form sigma points for measurement step
         SX = repeat(m, 1, 2 * n) + cholesky(Hermitian(P)).L * XI
         HY = sin.(SX[1, :])

         # Compute the updated mean and covariance
         mu = zeros(1,1)
         S = zeros(1,1)
         C = zeros(2, 1)

         for i in 1:size(SX, 2)
             mu =  mu .+W[i] .* HY[i]'
         end

         for i in 1:size(SX, 2)
             S = S + W[i] .* (HY[i]'.- mu) * (HY[i]'.- mu)'
             C = C .+ W[i] .* (SX[:, i] .- m) * (HY[i]' .- mu)'
         end
         S =S .+ R

         # Compute the gain and updated mean and covariance
         K = C / S
         m = m .+  K * (Y[k] .- mu)
         P = P .- K * S * K'

         #MM[:, k] = m
         #PP[:, :, k] = P
     end

     for  i = 1:length(predicted_m)
         data[i] ~ Normal(sin(predicted_m[i]),σ1^2)
     end
end


model = fitmb(Y)

chain = sample(model, NUTS(0.65), 2000; progress=true)
display(chain)

gr();
plot(chain)
nm="chain_"*Dates.format(Dates.now(), "d u yyyy H:m:s")
println(nm)
png(nm)

using CSV, DataFrames

# Convert chain to DataFrame
chain_df = DataFrame(chain)
# Save to CSV
full_path_nm="your_path"
CSV.write(full_path_nm*"chain_bat_CKF"*nm*".csv", chain_df)




# Chains MCMC chain (2000×16×1 Array{Float64, 3}):
#
# Iterations        = 1001:1:3000
# Number of chains  = 1
# Samples per chain = 2000
# Wall duration     = 841.89 seconds
# Compute duration  = 841.89 seconds
# parameters        = σ1, dt, R, g
# internals         = lp, n_steps, is_accept, acceptance_rate, log_density, hamiltonian_energy, hamiltonian_energy_error, max_hamiltonian_energy_error, tree_depth, numerical_error, step_size, nom_step_size
#
# Summary Statistics
#   parameters      mean       std   naive_se      mcse         ess      rhat   ess_per_sec
#       Symbol   Float64   Float64    Float64   Float64     Float64   Float64       Float64
#
#           σ1    0.5725    0.0087     0.0002    0.0002   1781.2597    0.9996        2.1158
#           dt    0.0092    0.0006     0.0000    0.0000   1627.6389    0.9997        1.9333
#            R    0.1008    0.0102     0.0002    0.0002   1937.0170    0.9996        2.3008
#            g    9.8098    0.0196     0.0004    0.0004   1687.2795    0.9995        2.0042
#
# Quantiles
#   parameters      2.5%     25.0%     50.0%     75.0%     97.5%
#       Symbol   Float64   Float64   Float64   Float64   Float64
#
#           σ1    0.5562    0.5666    0.5722    0.5785    0.5895
#           dt    0.0078    0.0089    0.0093    0.0097    0.0100
#            R    0.0813    0.0938    0.1006    0.1077    0.1206
#            g    9.7698    9.7971    9.8106    9.8232    9.8484
#
# chain_30 Jan 2024 20:1:776
#
#
# Chains MCMC chain (2000×16×1 Array{Float64, 3}):
#
# Iterations        = 1001:1:3000
# Number of chains  = 1
# Samples per chain = 2000
# Wall duration     = 882.29 seconds
# Compute duration  = 882.29 seconds
# parameters        = σ1, dt, R, g
# internals         = lp, n_steps, is_accept, acceptance_rate, log_density, hamiltonian_energy, hamiltonian_energy_error, max_hamiltonian_energy_error, tree_depth, numerical_error, step_size, nom_step_size
#
# Summary Statistics
#   parameters      mean       std   naive_se      mcse         ess      rhat   ess_per_sec
#       Symbol   Float64   Float64    Float64   Float64     Float64   Float64       Float64
#
#           σ1    0.5732    0.0090     0.0002    0.0001   2293.5420    0.9997        2.5995
#           dt    0.0092    0.0006     0.0000    0.0000   1872.2214    0.9995        2.1220
#            R    0.1009    0.0101     0.0002    0.0002   2459.8277    0.9996        2.7880
#            g    9.8098    0.0204     0.0005    0.0006   1492.7244    0.9995        1.6919
#
# Quantiles
#   parameters      2.5%     25.0%     50.0%     75.0%     97.5%
#       Symbol   Float64   Float64   Float64   Float64   Float64
#
#           σ1    0.5559    0.5669    0.5729    0.5791    0.5914
#           dt    0.0077    0.0088    0.0093    0.0097    0.0100
#            R    0.0807    0.0941    0.1009    0.1077    0.1209
#            g    9.7703    9.7962    9.8096    9.8232    9.8517
#
# chain_30 Jan 2024 20:1:033







DT = 0.01
g = 9.81
Q = 0.01 * [DT^3/3 DT^2/2; DT^2/2 DT]
R = 0.1
m0 = [0.0; 0.0]
P0 = [1.0 0.0; 0.0 1.0]

steps = 500

# Generate simulated data
QL = cholesky(Q).L
T = zeros(steps)
X = zeros(2, steps)
Y = zeros(steps)
t = 0.0
x = [1.5; 0.0]
for k in 1:steps
    x = [x[1] + x[2] * DT; x[2] - g * sin(x[1]) * DT]
    w = QL* randn(2)
    x += w
    y = sin(x[1]) + sqrt(R) * randn()   #Example 5.2 (Measurement model for noisy pendulum) in Simo's Book.
    t += DT
    T[k] = t
    X[:, k] = x
    Y[k] = y
end




chain_bat_CKF = CSV.read("./chain_bat_CKFchain_30 Jan 2024 20:1:033.csv", DataFrame)
println(mean(chain_bat_CKF[:,4])," : dt")
println(mean(chain_bat_CKF[:,5])," : R")
println(mean(chain_bat_CKF[:,6])," : g")



DT = mean(chain_bat_CKF[:,4])
g = mean(chain_bat_CKF[:,6])
Q = 0.01 * [DT^3/3 DT^2/2; DT^2/2 DT]
R = mean(chain_bat_CKF[:,5])

m0 = [0.0; 0.0]
P0 = [1 0.0; 0.0 1.0]



# CKF Filter
m = m0
P = P0

# Precompute the UT weights
n = size(m, 1)

XI = sqrt(n) * [Matrix{Float64}(I, n, n) -Matrix{Float64}(I, n, n)]
W = ones(2 * n) / (2 * n)

# Do the filtering
MM = zeros(size(m, 1), length(Y))
PP = zeros(size(P, 1), size(P, 2), length(Y))

for k in 1:length(Y)
    # Form the sigma points for dynamic model
    SX = repeat(m, 1, 2 * n) + cholesky(Hermitian(P)).L * XI

    # Propagate through the dynamic model
    HX = hcat(SX[1, :] .+ SX[2, :] .* DT, SX[2, :] .- g .* sin.(SX[1, :]) .* DT)'

    # Compute the predicted mean and covariance
    m = zeros(size(m))
    P = zeros(size(P))
    for i in 1:size(HX, 2)
        m .+= W[i] .* HX[:, i]
    end
    for i in 1:size(HX, 2)
        P .+= W[i] .* (HX[:, i] .- m) * (HX[:, i] .- m)'
    end
    P .+= Q

    # Form sigma points for measurement step
    SX = repeat(m, 1, 2 * n) + cholesky(Hermitian(P)).L * XI
    HY = sin.(SX[1, :])

    # Compute the updated mean and covariance
    mu = zeros(1,1)
    S = zeros(1,1)
    C = zeros(2, 1)

    for i in 1:size(SX, 2)
        mu .+= W[i] .* HY[i]'
    end

    for i in 1:size(SX, 2)
        S = S + W[i] .* (HY[i]'.- mu) * (HY[i]'.- mu)'
        C .+= W[i] .* (SX[:, i] .- m) * (HY[i]' .- mu)'
    end
    S .+= R


    # Compute the gain and updated mean and covariance
    K = C / S
    m .+= K * (Y[k] .- mu)
    P .-= K * S * K'

    MM[:, k] = m
    PP[:, :, k] = P
end
#
# lws=6
# gr( xtickfontsize=7, ytickfontsize=7, xguidefontsize=9, yguidefontsize=9, legendfontsize=8);
# p1=plot(T, Y, seriestype=:scatter, label="Measurements", color=:green)
# plot!(T, X1, linecolor=:blue, label="True angle",lw=lws)
# plot!(T, MM[1, :], color=:red, label="CKF estimate",lw=lws)
# xlabel!("t")
# ylabel!(L"Pendulum~angle~X_{1,k}")
# display(p1)
# png("BAT_CKF")
#
#
#
# # Calculate RMSE
# rmse_ckf = sqrt(mean((X1 .- MM[1, :]).^2))
# println("RMSE of CKF: ", rmse_ckf)



lws=6
gr( xtickfontsize=7, ytickfontsize=7, xguidefontsize=9, yguidefontsize=9, legendfontsize=8);
p1=plot(T, Y, seriestype=:scatter, label="Measurements", color=:green)
plot!(T, X[1, :], linecolor=:blue, label="True angle",lw=lws)
plot!(T, MM[1, :], color=:red, label="CKF estimate",lw=lws)
xlabel!("t")
ylabel!(L"Pendulum~angle~X_{1,k}")
display(p1)
png("BAT_CKF2")


# Calculate RMSE
rmse_ukf = sqrt(mean((X[1, :] .- MM[1, :]).^2))
println("RMSE of CKF: ", rmse_ukf)
